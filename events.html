<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ˜Ÿç©ºæƒ…å ±å±€ - Starry Sky Bureau</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Shippori+Mincho:wght@400;500&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="assets/css/base.css">
    <link rel="stylesheet" href="assets/css/pages.css">
</head>
<body>
    
    <div class="menu-container">
        <button id="menu-toggle" class="menu-toggle" aria-label="ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é–‹ã">
            <span class="line"></span>
            <span class="line"></span>
            <span class="line"></span>
        </button>
        
        <nav id="nav-overlay" class="nav-overlay">
            <ul class="nav-list">
                <li><a href="index.html" class="nav-link">ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸<span>Home</span></a></li>
                <li><a href="stars.html" class="nav-link">æ˜Ÿã‚’æ¢ã™<span>Star Chart</span></a></li>
                <li><a href="events.html" class="nav-link">æ˜Ÿç©ºæƒ…å ±å±€<span>Sky Events</span></a></li>
                <li><a href="theater.html" class="nav-link">å®‡å®™ã‚·ã‚¢ã‚¿ãƒ¼<span>Space Theater</span></a></li>
                <li><a href="lifelog.html" class="nav-link">æ˜Ÿç©ºãƒ©ã‚¤ãƒ•ãƒ­ã‚°<span>My Logbook</span></a></li>
            </ul>
        </nav>
    </div>

    <header class="common-header">
        <a href="index.html" class="header-back-btn">ãƒˆãƒƒãƒ—ã¸æˆ»ã‚‹</a>
        <h1 class="page-title">æ˜Ÿç©ºæƒ…å ±å±€</h1>
    </header>

    <div class="container">
        <div class="calendar-wrapper">
            <div class="section-header" style="display:flex; justify-content:space-between; align-items:center; border:none;">
                <button class="btn-submit" id="prev-month" style="width:auto; padding:5px 15px;">&lt;</button>
                <div class="month-label" id="current-month" style="font-size:1.5rem; color:var(--accent-gold);">----å¹´ --æœˆ</div>
                <button class="btn-submit" id="next-month" style="width:auto; padding:5px 15px;">&gt;</button>
            </div>
            <div class="calendar-grid" id="calendar-grid"></div>
        </div>

        <div class="panel-bg" style="height:fit-content;">
            <div class="section-header" id="selected-date">æ—¥ä»˜ã‚’é¸æŠã—ã¦ãã ã•ã„</div>
            <div id="event-list">
                <p style="opacity:0.6;">ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®æ—¥ä»˜ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ã€<br>ãã®æ—¥ã®è©³ç´°ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</p>
            </div>
        </div>
    </div>

    <script src="assets/js/script.js"></script>
    
    <script type="module">
        import { Amplify } from 'aws-amplify';
        import { generateClient } from 'aws-amplify/data';
        import outputs from './amplify_outputs.json';

        // Amplifyã®è¨­å®š
        Amplify.configure(outputs);
        const client = generateClient();

        // ãƒ‡ãƒ¼ã‚¿æ ¼ç´ç”¨å¤‰æ•°
        let eventsData = {};

        // ä»Šæ—¥ã®æ—¥ä»˜ã‚’å–å¾—
        const today = new Date();
        let currentYear = today.getFullYear();
        let currentMonth = today.getMonth();

        const gridEl = document.getElementById('calendar-grid');
        const labelEl = document.getElementById('current-month');
        const selectedDateEl = document.getElementById('selected-date');
        const eventListEl = document.getElementById('event-list');



        // 2. AWSã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã™ã‚‹é–¢æ•°
        async function fetchEvents() {
            try {
                const { data: items } = await client.models.Event.list();
                console.log("å–å¾—ã—ãŸã‚¤ãƒ™ãƒ³ãƒˆãƒ‡ãƒ¼ã‚¿:", items);

                eventsData = {}; 
                
                items.forEach(item => {
                    // ã‚¬ãƒ¼ãƒ‰å‡¦ç†: itemè‡ªä½“ãŒnullã€ã¾ãŸã¯æ—¥ä»˜ãŒç„¡ã„ãƒ‡ãƒ¼ã‚¿ã¯ç„¡è¦–ã™ã‚‹
                    if (!item || !item.date) {
                        return; 
                    }

                    const dateKey = item.date; 
                    if (!eventsData[dateKey]) {
                        eventsData[dateKey] = [];
                    }
                    eventsData[dateKey].push({
                        title: item.title,
                        type: item.type,
                        time: item.time,
                        desc: item.description
                    });
                });

                // ãƒ‡ãƒ¼ã‚¿å–å¾—å®Œäº†å¾Œã«ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’æç”»
                generateCalendar(currentYear, currentMonth);

            } catch (error) {
                console.error("ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:", error);
                eventListEl.innerHTML = '<p style="color:#ff9999;">ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚</p>';
            }
        }

        // 3. ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ç”Ÿæˆãƒ­ã‚¸ãƒƒã‚¯
        function generateCalendar(year, month) {
            gridEl.innerHTML = '';
            
            const days = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];
            days.forEach(d => {
                const div = document.createElement('div');
                div.className = 'day-name'; 
                div.style.color='rgba(255,255,255,0.6)'; 
                div.style.fontSize='0.9rem'; 
                div.style.paddingBottom='0.5rem'; 
                div.textContent = d; 
                gridEl.appendChild(div);
            });

            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            
            labelEl.textContent = `${year}å¹´ ${month + 1}æœˆ`;

            for (let i = 0; i < firstDay; i++) {
                gridEl.appendChild(document.createElement('div'));
            }

            for (let d = 1; d <= daysInMonth; d++) {
                const cell = document.createElement('div');
                cell.className = 'calendar-day';
                
                const dateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                
                const now = new Date();
                if (year === now.getFullYear() && month === now.getMonth() && d === now.getDate()) {
                    cell.classList.add('today');
                }

                const numSpan = document.createElement('div');
                numSpan.className = 'day-number'; 
                numSpan.style.fontSize='1.1rem'; 
                numSpan.style.marginBottom='5px'; 
                numSpan.textContent = d; 
                cell.appendChild(numSpan);

                // ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Œã°ãƒ‰ãƒƒãƒˆã‚’è¡¨ç¤º
                if (eventsData[dateStr]) {
                    eventsData[dateStr].forEach(evt => {
                        const dot = document.createElement('span');
                        dot.className = `event-dot dot-${evt.type}`; 
                        cell.appendChild(dot);
                    });
                }
                
                cell.addEventListener('click', () => showDetails(dateStr));
                gridEl.appendChild(cell);
            }
        }

        // 4. è©³ç´°è¡¨ç¤ºãƒ­ã‚¸ãƒƒã‚¯
        function showDetails(dateStr) {
            selectedDateEl.textContent = dateStr;
            eventListEl.innerHTML = '';
            
            const events = eventsData[dateStr];
            
            if (events && events.length > 0) {
                events.forEach(evt => {
                    const card = document.createElement('div');
                    card.className = 'log-card';
                    card.style.marginBottom = '1rem';
                    
                    const typeLabel = evt.type === 'star' ? 'å¤©æ–‡ç¾è±¡' : 'ãƒ­ã‚±ãƒƒãƒˆ';
                    const typeColor = evt.type === 'star' ? '#a0d9ff' : '#ff9999';
                    
                    card.innerHTML = `
                        <div style="display:flex; flex-direction:column; justify-content:center; align-items:center; border-right:1px solid rgba(255,255,255,0.1); padding-right:1rem;">
                            <span style="font-size:1.5rem;">ğŸ“…</span>
                        </div>
                        <div>
                            <span style="font-size:0.8rem; padding:2px 6px; border-radius:4px; border:1px solid ${typeColor}; color:${typeColor}; display:inline-block; margin-bottom:0.5rem;">${typeLabel}</span>
                            <h3 style="margin:0 0 5px 0; color:var(--accent-gold);">${evt.title}</h3>
                            <div style="font-size:0.9rem; margin-bottom:5px;">â° ${evt.time}</div>
                            <p style="font-size:0.85rem; margin:0; opacity:0.8;">${evt.desc}</p>
                        </div>
                    `;
                    eventListEl.appendChild(card);
                });
            } else {
                eventListEl.innerHTML = '<p style="opacity:0.6;">ã“ã®æ—¥ã®ã‚¤ãƒ™ãƒ³ãƒˆæƒ…å ±ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
            }
        }

        // ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¦ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’è¡¨ç¤º
        fetchEvents();

        document.getElementById('prev-month').addEventListener('click', () => {
            currentMonth--; 
            if(currentMonth < 0){ currentMonth = 11; currentYear--; } 
            generateCalendar(currentYear, currentMonth);
        });
        
        document.getElementById('next-month').addEventListener('click', () => {
            currentMonth++; 
            if(currentMonth > 11){ currentMonth = 0; currentYear++; } 
            generateCalendar(currentYear, currentMonth);
        });
    </script>
</body>
</html>