<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚¤ãƒ™ãƒ³ãƒˆç®¡ç† - Admin</title>
    <link href="https://fonts.googleapis.com/css2?family=Shippori+Mincho:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="assets/css/base.css">
    <link rel="stylesheet" href="assets/css/pages.css">
    <style>
        .admin-wrapper { display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; align-items: start; }
        .calendar-section { background: rgba(5, 10, 20, 0.6); border: 1px solid var(--accent-gold); border-radius: 8px; padding: 1.5rem; }
        .calendar-day { min-height: 60px; font-size: 0.9rem; }
        .calendar-day.selected { background: rgba(212, 175, 55, 0.3); border: 2px solid var(--accent-gold); }
        .manage-panel { display: flex; flex-direction: column; gap: 1.5rem; }
        .panel-box { background: var(--panel-bg); padding: 1.5rem; border-radius: 8px; border: 1px solid rgba(255,255,255,0.1); }
        .event-item { background: rgba(255,255,255,0.05); padding: 10px 15px; margin-bottom: 8px; border-radius: 4px; border-left: 3px solid var(--accent-gold); display: flex; justify-content: space-between; align-items: center; }
        .event-info { cursor: pointer; flex-grow: 1; }
        .btn-delete { background: #ff4444; color: white; border: none; padding: 4px 10px; border-radius: 4px; cursor: pointer; margin-left: 10px;}
        
        /* ç”»åƒãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”¨ */
        #preview-area { margin-top: 10px; text-align: center; display: none; }
        #preview-img { max-width: 100%; max-height: 200px; border: 1px solid #444; border-radius: 4px; }
        
        @media (max-width: 900px) { .admin-wrapper { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <header class="common-header">
        <a href="index.html" class="header-back-btn">ãƒˆãƒƒãƒ—ã¸æˆ»ã‚‹</a>
        <h1 class="page-title">ç®¡ç†è€…ã‚³ãƒ³ã‚½ãƒ¼ãƒ«</h1>
    </header>

    <div class="container admin-wrapper">
        <div class="calendar-section">
            <div class="section-header" style="display:flex; justify-content:space-between; align-items:center; border:none; margin-bottom:1rem;">
                <button class="btn-submit" id="prev-month" style="width:auto; padding:5px 15px;">&lt;</button>
                <div id="current-month" style="font-size:1.3rem; color:var(--accent-gold);">----å¹´ --æœˆ</div>
                <button class="btn-submit" id="next-month" style="width:auto; padding:5px 15px;">&gt;</button>
            </div>
            <div class="calendar-grid" id="calendar-grid"></div>
        </div>

        <div class="manage-panel">
            <div class="panel-box">
                <h2 class="section-header" id="selected-date-label">æ—¥ä»˜ã‚’é¸æŠã—ã¦ãã ã•ã„</h2>
                <div id="event-list-display"><p style="opacity:0.5;">ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®æ—¥ä»˜ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚</p></div>
            </div>

            <div class="panel-box">
                <h3 class="section-header">âœï¸ ç·¨é›† / æ–°è¦ç™»éŒ²</h3>
                <form id="admin-form">
                    <div style="margin-bottom:1rem;">
                        <label>ğŸ”‘ åˆè¨€è‘‰ (Password)</label>
                        <input type="password" id="input-password" placeholder="luna1234" required>
                    </div>
                    
                    <input type="hidden" id="input-id">
                    <input type="hidden" id="input-date">
                    
                    <input type="hidden" id="final-image-url"> 

                    <div class="form-row">
                        <div>
                            <label>ã‚¿ã‚¤ãƒˆãƒ«</label>
                            <input type="text" id="input-title" required>
                        </div>
                        <div>
                            <label>ã‚¿ã‚¤ãƒ—</label>
                            <select id="input-type">
                                <option value="meteor">ğŸ’« æµæ˜Ÿç¾¤</option>
                                <option value="eclipse">ğŸŒ‘ æ—¥é£Ÿãƒ»æœˆé£Ÿ</option>
                                <option value="phenomenon">ğŸª å¤©æ–‡ç¾è±¡</option>
                                <option value="rocket">ğŸš€ ãƒ­ã‚±ãƒƒãƒˆæ‰“ä¸Š</option>
                                <option value="other">âœ¨ ãã®ä»–</option>
                            </select>
                        </div>
                    </div>

                    <div>
                        <label>æ™‚é–“</label>
                        <input type="text" id="input-time" placeholder="ä¾‹: 22:00é ƒ">
                    </div>
                    
                    <div>
                        <label>ç”»åƒ (ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ)</label>
                        <input type="file" id="input-file" accept="image/*">
                        <div id="preview-area">
                            <p style="font-size:0.8rem; opacity:0.7;">ç¾åœ¨ã®è¨­å®šç”»åƒ:</p>
                            <img id="preview-img" src="">
                            <button type="button" id="btn-clear-img" style="font-size:0.8rem; margin-top:5px;">ç”»åƒã‚’å‰Šé™¤</button>
                        </div>
                    </div>

                    <div>
                        <label>è©³ç´°ãƒ»èª¬æ˜</label>
                        <textarea id="input-desc" rows="3" required></textarea>
                    </div>

                    <div style="display:flex; gap:10px; margin-top:1rem;">
                        <button type="submit" class="btn-submit" id="btn-save">ã“ã®å†…å®¹ã§ä¿å­˜</button>
                        <button type="button" class="btn-submit" id="btn-clear" style="background:#555;">ã‚¯ãƒªã‚¢</button>
                    </div>
                    <p id="msg-status" style="margin-top:10px; font-weight:bold; color:var(--accent-gold);"></p>
                </form>
            </div>
        </div>
    </div>

    <script>
        // â–¼â–¼â–¼ ã‚ãªãŸã®é–¢æ•°URLã‚’2ã¤è²¼ã£ã¦ãã ã•ã„ (é‡è¦ï¼) â–¼â–¼â–¼
        const GET_URL = "https://jjrfmiwd63rogmf7ockaffndty0ddhly.lambda-url.ap-northeast-1.on.aws/";
        const PUT_URL = "https://3k3w7lgiohcqh4i6m4zac534ju0nlvyx.lambda-url.ap-northeast-1.on.aws/";
        // â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²

        let eventsData = {};
        const today = new Date();
        let currentYear = today.getFullYear();
        let currentMonth = today.getMonth();
        let selectedDateStr = "";

        // DOMè¦ç´ 
        const gridEl = document.getElementById('calendar-grid');
        const monthLabelEl = document.getElementById('current-month');
        const selectedDateLabel = document.getElementById('selected-date-label');
        const listDisplay = document.getElementById('event-list-display');
        const form = document.getElementById('admin-form');
        const btnSave = document.getElementById('btn-save');
        const statusMsg = document.getElementById('msg-status');
        
        // ç”»åƒãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼é–¢é€£è¦ç´ 
        const inputFile = document.getElementById('input-file');
        const previewArea = document.getElementById('preview-area');
        const previewImg = document.getElementById('preview-img');
        const finalImageUrl = document.getElementById('final-image-url');
        const btnClearImg = document.getElementById('btn-clear-img');

        init();

        async function init() {
            const y = today.getFullYear();
            const m = String(today.getMonth() + 1).padStart(2, '0');
            const d = String(today.getDate()).padStart(2, '0');
            selectedDateStr = `${y}-${m}-${d}`;
            
            await fetchAllEvents();
            renderCalendar(currentYear, currentMonth);
            selectDate(selectedDateStr);
        }

        async function fetchAllEvents() {
            try {
                const res = await fetch(GET_URL);
                if(!res.ok) throw new Error("Fetch failed");
                eventsData = await res.json();
            } catch (e) {
                console.error(e);
                alert("ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚GET_URLã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
            }
        }

        function renderCalendar(year, month) {
            gridEl.innerHTML = '';
            const days = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];
            days.forEach(d => {
                const div = document.createElement('div');
                div.className = 'day-name';
                div.style.textAlign='center'; div.style.fontSize='0.8rem'; div.style.color='rgba(255,255,255,0.6)';
                div.textContent = d;
                gridEl.appendChild(div);
            });
            monthLabelEl.textContent = `${year}å¹´ ${month + 1}æœˆ`;
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            for (let i = 0; i < firstDay; i++) gridEl.appendChild(document.createElement('div'));
            for (let d = 1; d <= daysInMonth; d++) {
                const cell = document.createElement('div');
                cell.className = 'calendar-day';
                const dateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                if (dateStr === selectedDateStr) cell.classList.add('selected');
                const numDiv = document.createElement('div');
                numDiv.textContent = d; numDiv.style.fontWeight='bold';
                cell.appendChild(numDiv);
                if (eventsData[dateStr]) {
                    eventsData[dateStr].forEach(evt => {
                        const dot = document.createElement('span');
                        dot.className = `event-dot dot-${evt.type || 'other'}`;
                        cell.appendChild(dot);
                    });
                }
                cell.addEventListener('click', () => selectDate(dateStr));
                gridEl.appendChild(cell);
            }
        }

        function selectDate(dateStr) {
            selectedDateStr = dateStr;
            selectedDateLabel.textContent = `${dateStr} ã®ã‚¤ãƒ™ãƒ³ãƒˆ`;
            document.getElementById('input-date').value = dateStr;
            document.querySelectorAll('.calendar-day').forEach(el => el.classList.remove('selected'));
            renderCalendar(currentYear, currentMonth);
            renderEventList(dateStr);
            clearForm();
        }

        function renderEventList(dateStr) {
            listDisplay.innerHTML = '';
            const events = eventsData[dateStr] || [];
            if (events.length === 0) {
                listDisplay.innerHTML = '<p style="opacity:0.6;">ã‚¤ãƒ™ãƒ³ãƒˆã¯ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</p>';
                return;
            }
            events.forEach(evt => {
                const div = document.createElement('div');
                div.className = 'event-item';
                div.innerHTML = `
                    <div class="event-info" onclick='loadToForm(${JSON.stringify(evt)})'>
                        <strong>${evt.title}</strong>
                        <span style="font-size:0.8rem; opacity:0.7; margin-left:8px;">${evt.type}</span>
                    </div>
                    <button class="btn-delete" onclick='deleteEvent("${evt.id}")'>å‰Šé™¤</button>
                `;
                listDisplay.appendChild(div);
            });
        }

        window.loadToForm = (evt) => {
            document.getElementById('input-id').value = evt.id || "";
            document.getElementById('input-title').value = evt.title;
            document.getElementById('input-type').value = evt.type;
            document.getElementById('input-time').value = evt.time;
            document.getElementById('input-desc').value = evt.desc;
            
            // ç”»åƒæƒ…å ±ã®ã‚»ãƒƒãƒˆ
            finalImageUrl.value = evt.image || "";
            if (evt.image) {
                previewImg.src = evt.image;
                previewArea.style.display = 'block';
            } else {
                previewArea.style.display = 'none';
            }
            
            inputFile.value = ""; // ãƒ•ã‚¡ã‚¤ãƒ«å…¥åŠ›ã¯ãƒªã‚»ãƒƒãƒˆ
            btnSave.textContent = "æ›´æ–°ã™ã‚‹ (ä¸Šæ›¸ã)";
            btnSave.style.background = "#4CAF50";
            statusMsg.textContent = "ğŸ“ ç·¨é›†ãƒ¢ãƒ¼ãƒ‰";
        };

        function clearForm() {
            document.getElementById('input-id').value = "";
            document.getElementById('input-title').value = "";
            document.getElementById('input-desc').value = "";
            document.getElementById('input-time').value = "";
            
            finalImageUrl.value = "";
            inputFile.value = "";
            previewArea.style.display = 'none';

            btnSave.textContent = "ã“ã®å†…å®¹ã§æ–°è¦ç™»éŒ²";
            btnSave.style.background = "var(--accent-gold)";
            statusMsg.textContent = "";
        }
        document.getElementById('btn-clear').addEventListener('click', clearForm);

        // ç”»åƒå‰Šé™¤ãƒœã‚¿ãƒ³
        btnClearImg.addEventListener('click', () => {
            finalImageUrl.value = "";
            previewArea.style.display = 'none';
            inputFile.value = "";
        });

        // â–  ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰é–¢æ•°
        async function uploadImage(file) {
            const password = document.getElementById('input-password').value;
            
            // 1. Lambdaã‹ã‚‰ç½²åä»˜ãURLã‚’å–å¾—
            const res = await fetch(PUT_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    password: password,
                    action: 'getUploadUrl',
                    fileName: file.name,
                    fileType: file.type
                })
            });
            
            if (!res.ok) throw new Error("ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰è¨±å¯ã®å–å¾—ã«å¤±æ•— (åˆè¨€è‘‰ã¯æ­£ã—ã„ã§ã™ã‹ï¼Ÿ)");
            const data = await res.json();
            
            // 2. S3ã¸ç›´æ¥ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
            const uploadRes = await fetch(data.uploadUrl, {
                method: 'PUT',
                body: file,
                headers: { 'Content-Type': file.type }
            });
            
            if (!uploadRes.ok) throw new Error("ç”»åƒã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—");
            
            return data.publicUrl; // å…¬é–‹ç”¨URLã‚’è¿”ã™
        }

        // é€ä¿¡å‡¦ç†
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('input-id').value;
            const action = id ? "edit" : "add";
            const password = document.getElementById('input-password').value;

            if(!password) { alert("åˆè¨€è‘‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }
            btnSave.disabled = true;
            statusMsg.textContent = "é€ä¿¡ä¸­...";

            try {
                // ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å‡¦ç†
                const file = inputFile.files[0];
                if (file) {
                    statusMsg.textContent = "ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­...";
                    const uploadedUrl = await uploadImage(file);
                    finalImageUrl.value = uploadedUrl;
                }

                statusMsg.textContent = "ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ä¸­...";

                const eventData = {
                    id: id,
                    title: document.getElementById('input-title').value,
                    type: document.getElementById('input-type').value,
                    time: document.getElementById('input-time').value,
                    image: finalImageUrl.value, // ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ¸ˆã¿ or æ—¢å­˜ã®URL
                    desc: document.getElementById('input-desc').value
                };

                const res = await fetch(PUT_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        password: password,
                        date: selectedDateStr,
                        action: action,
                        eventData: eventData
                    })
                });
                
                const result = await res.json();
                
                if(res.ok) {
                    statusMsg.textContent = "âœ… å‡¦ç†å®Œäº†ï¼";
                    await fetchAllEvents();
                    renderCalendar(currentYear, currentMonth);
                    renderEventList(selectedDateStr);
                    if(action !== 'edit') clearForm();
                } else {
                    statusMsg.textContent = "â›” ã‚¨ãƒ©ãƒ¼: " + result.message;
                    if(result.message === "åˆè¨€è‘‰ãŒé•ã„ã¾ã™") {
                        alert("åˆè¨€è‘‰ãŒé•ã„ã¾ã™ã€‚ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
                    }
                }
            } catch(e) {
                console.error(e);
                statusMsg.textContent = "ã‚¨ãƒ©ãƒ¼: " + e.message;
            } finally {
                btnSave.disabled = false;
            }
        });

        // å‰Šé™¤å‡¦ç†
        window.deleteEvent = async (id) => {
            if(!confirm("æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
            const password = document.getElementById('input-password').value;
            if(!password) { alert("åˆè¨€è‘‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }
            
            try {
                const res = await fetch(PUT_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        password: password,
                        date: selectedDateStr,
                        action: 'delete',
                        eventData: { id: id }
                    })
                });
                if(res.ok) {
                    await fetchAllEvents();
                    renderCalendar(currentYear, currentMonth);
                    renderEventList(selectedDateStr);
                } else {
                    alert("å‰Šé™¤å¤±æ•—: åˆè¨€è‘‰ã‚’ç¢ºèªã—ã¦ãã ã•ã„");
                }
            } catch(e) { alert("é€šä¿¡ã‚¨ãƒ©ãƒ¼"); }
        };

        // æœˆåˆ‡ã‚Šæ›¿ãˆ
        document.getElementById('prev-month').addEventListener('click', () => {
            currentMonth--; 
            if(currentMonth < 0){ currentMonth = 11; currentYear--; } 
            renderCalendar(currentYear, currentMonth);
        });
        document.getElementById('next-month').addEventListener('click', () => {
            currentMonth++; 
            if(currentMonth > 11){ currentMonth = 0; currentYear++; } 
            renderCalendar(currentYear, currentMonth);
        });
    </script>
</body>
</html>