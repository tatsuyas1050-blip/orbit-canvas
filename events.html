<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ˜Ÿç©ºæƒ…å ±å±€ - Starry Sky Bureau</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Shippori+Mincho:wght@400;500&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="assets/css/base.css">
    <link rel="stylesheet" href="assets/css/pages.css">
</head>
<body>
    
    <div class="menu-container">
        <button id="menu-toggle" class="menu-toggle" aria-label="ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é–‹ã">
            <span class="line"></span>
            <span class="line"></span>
            <span class="line"></span>
        </button>
        
        <nav id="nav-overlay" class="nav-overlay">
            <ul class="nav-list">
                <li><a href="index.html" class="nav-link">ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸<span>Home</span></a></li>
                <li><a href="stars.html" class="nav-link">æ˜Ÿã‚’æ¢ã™<span>Star Chart</span></a></li>
                <li><a href="events.html" class="nav-link">æ˜Ÿç©ºæƒ…å ±å±€<span>Sky Events</span></a></li>
                <li><a href="theater.html" class="nav-link">å®‡å®™ã‚·ã‚¢ã‚¿ãƒ¼<span>Space Theater</span></a></li>
                <li><a href="lifelog.html" class="nav-link">æ˜Ÿç©ºãƒ©ã‚¤ãƒ•ãƒ­ã‚°<span>My Logbook</span></a></li>
            </ul>
        </nav>
    </div>

    <header class="common-header">
        <a href="index.html" class="header-back-btn">ãƒˆãƒƒãƒ—ã¸æˆ»ã‚‹</a>
        <h1 class="page-title">æ˜Ÿç©ºæƒ…å ±å±€</h1>
    </header>

    <div class="container">
        <div class="calendar-wrapper">
            <div class="section-header" style="display:flex; justify-content:space-between; align-items:center; border:none;">
                <button class="btn-submit" id="prev-month" style="width:auto; padding:5px 15px;">&lt;</button>
                <div class="month-label" id="current-month" style="font-size:1.5rem; color:var(--accent-gold);">----å¹´ --æœˆ</div>
                <button class="btn-submit" id="next-month" style="width:auto; padding:5px 15px;">&gt;</button>
            </div>
            <div class="calendar-grid" id="calendar-grid"></div>
        </div>

        <div class="panel-bg" style="height:fit-content;">
            <div class="section-header" id="selected-date">æ—¥ä»˜ã‚’é¸æŠã—ã¦ãã ã•ã„</div>
            <div id="event-list">
                <p style="opacity:0.6;">ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®æ—¥ä»˜ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ã€<br>ãã®æ—¥ã®è©³ç´°ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</p>
            </div>
        </div>
    </div>

    <script src="assets/js/script.js"></script>
    
    <script>
        // â–¼â–¼â–¼ ã“ã“ã«AWS Lambdaã®é–¢æ•°URLã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ â–¼â–¼â–¼
        const API_URL = "https://jjrfmiwd63rogmf7ockaffndty0ddhly.lambda-url.ap-northeast-1.on.aws/";
        // â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²

        // ã‚¤ãƒ™ãƒ³ãƒˆãƒ‡ãƒ¼ã‚¿æ ¼ç´ç”¨ï¼ˆæœ€åˆã¯ç©ºã€ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰å–å¾—ã—ã¦åŸ‹ã‚ã‚‹ï¼‰
        let eventsData = {};

        const today = new Date();
        let currentYear = today.getFullYear(); 
        let currentMonth = today.getMonth();

        const gridEl = document.getElementById('calendar-grid');
        const labelEl = document.getElementById('current-month');
        const selectedDateEl = document.getElementById('selected-date');
        const eventListEl = document.getElementById('event-list');

        // 1. ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã™ã‚‹é–¢æ•°
        async function fetchEvents() {
            try {
                // ãƒ­ãƒ¼ãƒ‰ä¸­è¡¨ç¤º
                eventListEl.innerHTML = '<p style="opacity:0.6;">ã‚¤ãƒ™ãƒ³ãƒˆæƒ…å ±ã‚’å–å¾—ä¸­...</p>';
                
                // APIå‘¼ã³å‡ºã—
                const response = await fetch(API_URL);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                // ãƒ‡ãƒ¼ã‚¿ã®å—ã‘å–ã‚Š
                eventsData = await response.json();
                console.log("Data loaded:", eventsData);

                // ãƒ‡ãƒ¼ã‚¿å–å¾—å®Œäº†å¾Œã«ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’æç”»
                generateCalendar(currentYear, currentMonth);
                
                // ãƒ­ãƒ¼ãƒ‰å®Œäº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆã¾ãŸã¯åˆæœŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼‰ã«æˆ»ã™
                eventListEl.innerHTML = '<p style="opacity:0.6;">ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®æ—¥ä»˜ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ã€<br>ãã®æ—¥ã®è©³ç´°ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</p>';

            } catch (error) {
                console.error("ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ:", error);
                eventListEl.innerHTML = `
                    <p style="opacity:0.6; color:#ff9999;">
                        ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚<br>
                        <small>${error.message}</small>
                    </p>
                `;
                // ã‚¨ãƒ©ãƒ¼æ™‚ã‚‚ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æ ã ã‘ã¯æç”»ã—ã¦ãŠã
                generateCalendar(currentYear, currentMonth);
            }
        }

        // 2. ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ç”Ÿæˆé–¢æ•°
        function generateCalendar(year, month) {
            gridEl.innerHTML = '';
            
            // æ›œæ—¥ã®ãƒ˜ãƒƒãƒ€ãƒ¼ä½œæˆ
            const days = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];
            days.forEach(d => {
                const div = document.createElement('div');
                div.className = 'day-name'; 
                div.style.color='rgba(255,255,255,0.6)'; div.style.fontSize='0.9rem'; div.style.paddingBottom='0.5rem'; 
                div.textContent = d; 
                gridEl.appendChild(div);
            });

            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            labelEl.textContent = `${year}å¹´ ${month + 1}æœˆ`;

            // ç©ºç™½ã‚»ãƒ«ã®è¿½åŠ ï¼ˆæœˆåˆã‚ã®æ›œæ—¥èª¿æ•´ï¼‰
            for (let i = 0; i < firstDay; i++) gridEl.appendChild(document.createElement('div'));

            // æ—¥ä»˜ã‚»ãƒ«ã®ç”Ÿæˆ
            for (let d = 1; d <= daysInMonth; d++) {
                const cell = document.createElement('div');
                cell.className = 'calendar-day';
                
                // ã‚­ãƒ¼ã¨ã—ã¦ä½¿ã†æ—¥ä»˜æ–‡å­—åˆ— (YYYY-MM-DD)
                const dateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                
                // ä»Šæ—¥ã®æ—¥ä»˜ã«ãƒãƒ¼ã‚¯
                const now = new Date();
                if (year === now.getFullYear() && month === now.getMonth() && d === now.getDate()) {
                    cell.classList.add('today');
                }

                const numSpan = document.createElement('div');
                numSpan.className = 'day-number'; numSpan.style.fontSize='1.1rem'; numSpan.style.marginBottom='5px'; 
                numSpan.textContent = d; 
                cell.appendChild(numSpan);

                // å–å¾—ã—ãŸãƒ‡ãƒ¼ã‚¿ã®ä¸­ã«ã€ã“ã®æ—¥ä»˜ã®ã‚¤ãƒ™ãƒ³ãƒˆãŒã‚ã‚‹ã‹ç¢ºèªã—ã¦ãƒ‰ãƒƒãƒˆã‚’è¡¨ç¤º
                if (eventsData[dateStr]) {
                    eventsData[dateStr].forEach(evt => {
                        const dot = document.createElement('span');
                        dot.className = `event-dot dot-${evt.type}`; 
                        cell.appendChild(dot);
                    });
                }
                
                // ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
                cell.addEventListener('click', () => showDetails(dateStr));
                gridEl.appendChild(cell);
            }
        }

        // 3. è©³ç´°è¡¨ç¤ºé–¢æ•°
 // 3. è©³ç´°è¡¨ç¤ºé–¢æ•°ï¼ˆæ›´æ–°ç‰ˆï¼‰
        function showDetails(dateStr) {
            selectedDateEl.textContent = dateStr;
            eventListEl.innerHTML = '';
            const events = eventsData[dateStr];
            
            // æ—¥æœ¬èªãƒ©ãƒ™ãƒ«ã¸ã®å¤‰æ›ãƒãƒƒãƒ—
            const typeLabels = {
                meteor: "æµæ˜Ÿç¾¤", eclipse: "æ—¥é£Ÿãƒ»æœˆé£Ÿ", phenomenon: "å¤©æ–‡ç¾è±¡",
                rocket: "ãƒ­ã‚±ãƒƒãƒˆæ‰“ä¸Š", other: "ãã®ä»–", star: "å¤©æ–‡ç¾è±¡" // starã¯äº’æ›æ€§ã®ãŸã‚æ®‹ã™
            };

            if (events && events.length > 0) {
                events.forEach((evt, index) => {
                    const card = document.createElement('div');
                    card.className = 'log-card';
                    card.style.marginBottom = '1rem';
                    
                    const typeClass = `type-${evt.type || 'other'}`;
                    const label = typeLabels[evt.type] || "ãã®ä»–";
                    
                    // ç”»åƒãŒã‚ã‚Œã°HTMLã‚’ç”Ÿæˆ
                    const imgHtml = evt.image ? `<img src="${evt.image}" class="event-image" alt="${evt.title}">` : '';

                    // ã‚«ãƒ¼ãƒ‰ã®ä¸­èº«
                    card.innerHTML = `
                        <div style="display:flex; flex-direction:column; justify-content:center; align-items:center; border-right:1px solid rgba(255,255,255,0.1); padding-right:1rem;">
                            <span style="font-size:1.5rem;">ğŸ“…</span>
                            <span style="font-size:0.7rem; opacity:0.6; margin-top:5px;">Click</span>
                        </div>
                        <div style="width:100%;">
                            <span class="type-badge ${typeClass}">${label}</span>
                            <h3 style="margin:0 0 5px 0; color:var(--accent-gold);">${evt.title}</h3>
                            <div style="font-size:0.9rem;">â° ${evt.time}</div>
                            
                            <div class="event-details-content" id="detail-${index}">
                                ${imgHtml}
                                <p style="font-size:0.9rem; line-height:1.6; opacity:0.9; margin:0;">${evt.desc.replace(/\n/g, '<br>')}</p>
                            </div>
                        </div>
                    `;
                    
                    // ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆï¼šè©³ç´°ã‚’é–‹é–‰
                    card.addEventListener('click', () => {
                        const content = document.getElementById(`detail-${index}`);
                        content.classList.toggle('open');
                    });

                    eventListEl.appendChild(card);
                });
            } else {
                eventListEl.innerHTML = '<p style="opacity:0.6;">ã“ã®æ—¥ã®ã‚¤ãƒ™ãƒ³ãƒˆæƒ…å ±ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
            }
        }

        // 4. åˆæœŸåŒ–å‡¦ç†ï¼šãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
        fetchEvents();

        // æœˆåˆ‡ã‚Šæ›¿ãˆãƒœã‚¿ãƒ³
        document.getElementById('prev-month').addEventListener('click', () => {
            currentMonth--; 
            if(currentMonth < 0){ currentMonth = 11; currentYear--; } 
            generateCalendar(currentYear, currentMonth);
        });
        document.getElementById('next-month').addEventListener('click', () => {
            currentMonth++; 
            if(currentMonth > 11){ currentMonth = 0; currentYear++; } 
            generateCalendar(currentYear, currentMonth);
        });
    </script>
</body>
</html>