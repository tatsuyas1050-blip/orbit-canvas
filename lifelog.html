<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ˜Ÿç©ºãƒ©ã‚¤ãƒ•ãƒ­ã‚° - My Observation Log</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Shippori+Mincho:wght@400;500;700&family=Jura:wght@400;600&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="assets/css/base.css">
    <link rel="stylesheet" href="assets/css/pages.css">
    
    <script src="https://unpkg.com/aws-amplify@4.3.43/dist/aws-amplify.min.js"></script>

    <style>
        :root {
            /* æ˜Ÿç©ºæƒ…å ±å±€ã¨åŒã˜å®šç¾© */
            --bg-deep: #080c15; 
            --card-bg: rgba(30, 40, 60, 0.5);
            --card-border: rgba(255, 255, 255, 0.2);
            --card-border-gold: rgba(212, 175, 55, 0.5);
            --glow-color: rgba(212, 175, 55, 0.3);
            --font-tech: 'Jura', sans-serif;
            --accent-gold: #d4af37;
            --accent-blue: #00d2ff;
            --accent-red: #ff5e5e; 
            --header-height: 80px;
            --text-main: #ffffff;
            --text-sub: #d0d0d0;
        }

        body {
            background-color: var(--bg-deep);
            background-image: radial-gradient(circle at 50% 0%, #2a3a55 0%, var(--bg-deep) 80%);
            height: 100vh;
            overflow: hidden;
            color: var(--text-main);
        }

        /* å…±é€šãƒ˜ãƒƒãƒ€ãƒ¼ */
        .common-header {
            height: var(--header-height);
            box-sizing: border-box;
            background: rgba(10, 15, 25, 0.85);
            backdrop-filter: blur(10px);
            position: absolute; top: 0; left: 0; width: 100%; z-index: 20;
            border-bottom: 1px solid rgba(255,255,255,0.15);
        }

        /* ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
        .dashboard-container {
            max-width: 1300px; 
            margin: 0 auto;
            padding-top: calc(var(--header-height) + 30px);
            padding-bottom: 2rem;
            padding-left: 2rem;
            padding-right: 2rem;
            height: 100vh;
            box-sizing: border-box;
            display: grid; 
            grid-template-columns: 320px 1fr; 
            gap: 2rem; 
            align-items: start;
            overflow: hidden; 
        }

        /* --- å·¦ã‚«ãƒ©ãƒ  (å›ºå®š) --- */
        .left-column {
            height: 100%;
            overflow-y: auto;
            scrollbar-width: none;
            display: flex; flex-direction: column; gap: 1.5rem;
            padding-bottom: 2rem;
        }
        .left-column::-webkit-scrollbar { display: none; }

        /* --- å³ã‚«ãƒ©ãƒ  (ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«) --- */
        .right-column { 
            height: 100%;
            overflow-y: auto; 
            padding: 0 1rem 4rem 0; 
            scrollbar-width: thin;
            scrollbar-color: rgba(255,255,255,0.3) transparent;
            position: relative;
        }
        .right-column::-webkit-scrollbar { width: 6px; }
        .right-column::-webkit-scrollbar-track { background: transparent; }
        .right-column::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.3); border-radius: 3px; }

        /* --- ã‚«ãƒ¼ãƒ‰å…±é€šã‚¹ã‚¿ã‚¤ãƒ« --- */
        .smart-card {
            background: var(--card-bg); 
            border: 1px solid var(--card-border);
            border-radius: 16px; 
            backdrop-filter: blur(12px);
            position: relative; overflow: hidden;
            transition: transform 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease;
            flex-shrink: 0; 
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        }
        .smart-card:hover {
            border-color: rgba(255, 255, 255, 0.3);
            box-shadow: 0 8px 30px rgba(0,0,0,0.3);
        }
        .smart-card::before {
            content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            border-radius: 16px; padding: 1px;
            background: radial-gradient(600px circle at var(--mouse-x) var(--mouse-y), rgba(255, 255, 255, 0.4), transparent 40%);
            -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            -webkit-mask-composite: xor; mask-composite: exclude; pointer-events: none; opacity: 0; transition: opacity 0.3s;
        }
        .smart-card:hover::before { opacity: 1; }

        /* --- å·¦: ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‘ãƒãƒ« --- */
        .profile-panel {
            padding: 1.5rem; text-align: center;
        }
        .btn-edit-profile {
            position: absolute; top: 1rem; right: 1rem;
            background: rgba(255,255,255,0.1); border: none; color: #fff;
            width: 30px; height: 30px; border-radius: 50%; cursor: pointer;
            display: flex; align-items: center; justify-content: center; transition: 0.3s;
        }
        .btn-edit-profile:hover { background: var(--accent-gold); color: #000; }

        .avatar-circle {
            width: 90px; height: 90px; 
            background: rgba(0,0,0,0.3); border: 2px solid var(--accent-gold);
            border-radius: 50%; margin: 0 auto 1rem;
            overflow: hidden; display: flex; align-items: center; justify-content: center;
            box-shadow: 0 0 20px rgba(212,175,55,0.2);
        }
        .avatar-circle img { width: 100%; height: 100%; object-fit: cover; }
        .avatar-default { font-size: 2.5rem; opacity: 0.8; }

        .user-name { font-size: 1.3rem; margin-bottom: 0.2rem; font-weight: 500; font-family: var(--font-main); text-shadow: 0 0 10px rgba(255,255,255,0.2); }
        .user-email { font-size: 0.75rem; color: var(--text-sub); margin-bottom: 1.5rem; font-family: var(--font-tech); letter-spacing: 0.05em; }

        /* çµ±è¨ˆè¡¨ç¤º (Log / Plan) */
        .stats-row { 
            display: flex; justify-content: center; gap: 1rem; 
            margin-top: 1.5rem;
        }
        .stat-item { 
            flex: 1; text-align: center; 
            background: rgba(0,0,0,0.2);
            border-radius: 8px; padding: 0.8rem 0.5rem;
            border: 1px solid rgba(255,255,255,0.1);
            transition: 0.3s;
        }
        /* ãƒ­ã‚°ç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
        .stat-item.log-theme {
            border-color: rgba(212, 175, 55, 0.3);
            background: linear-gradient(to bottom, rgba(212,175,55,0.05), transparent);
        }
        .stat-item.plan-theme {
            border-color: rgba(0, 210, 255, 0.3);
            background: linear-gradient(to bottom, rgba(0,210,255,0.05), transparent);
        }

        .stat-val { font-family: var(--font-tech); font-size: 1.5rem; line-height: 1; text-shadow: 0 0 8px rgba(0,0,0,0.5); }
        .log-theme .stat-val { color: var(--accent-gold); }
        .plan-theme .stat-val { color: var(--accent-blue); }

        .stat-label { font-size: 0.7rem; color: var(--text-sub); margin-top: 6px; letter-spacing: 0.1em; font-weight: bold; }

        /* --- å·¦: äºˆå®šãƒœã‚¿ãƒ³ --- */
        .btn-plan {
            width: 100%;
            background: linear-gradient(135deg, rgba(0, 210, 255, 0.2), rgba(0, 100, 200, 0.4));
            border: 1px solid rgba(0, 210, 255, 0.5);
            color: #d0f0ff;
            padding: 1.2rem; border-radius: 12px;
            font-family: 'Shippori Mincho', serif; font-size: 1.1rem;
            cursor: pointer; transition: all 0.3s;
            display: flex; align-items: center; justify-content: center; gap: 10px;
            box-shadow: 0 0 15px rgba(0, 210, 255, 0.1);
            text-shadow: 0 0 5px rgba(0, 210, 255, 0.5);
        }
        .btn-plan:hover { 
            background: linear-gradient(135deg, rgba(0, 210, 255, 0.4), rgba(0, 100, 200, 0.6));
            box-shadow: 0 0 25px rgba(0, 210, 255, 0.4); 
            text-shadow: 0 0 8px #fff; border-color: #fff;
            transform: translateY(-2px);
        }

        /* --- å·¦: äºˆå®šãƒªã‚¹ãƒˆ --- */
        .panel-header {
            padding: 1.2rem 1.2rem 0.5rem; display: flex; justify-content: space-between; align-items: flex-end;
            border-bottom: 1px solid rgba(255,255,255,0.1); margin-bottom: 0.5rem;
        }
        .panel-title { font-size: 1rem; color: #70d6ff; font-weight: bold; margin: 0; font-family: var(--font-tech); letter-spacing: 0.1em; }
        .wishlist-container { max-height: 400px; overflow-y: auto; padding: 0.5rem 1rem 1rem; }

        /* äºˆå®šã‚¢ã‚¤ãƒ†ãƒ  */
        .plan-item {
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(255,255,255,0.1);
            border-left: 3px solid #00d2ff;
            padding: 0.8rem; margin-bottom: 0.8rem; border-radius: 4px;
            cursor: pointer; transition: all 0.2s;
        }
        .plan-item:hover { background: rgba(255,255,255,0.08); border-color: rgba(255,255,255,0.3); }
        .plan-item.active { background: rgba(0, 210, 255, 0.1); border-color: #00d2ff; }

        .plan-head { display: flex; justify-content: space-between; align-items: center; }
        .plan-date { font-family: var(--font-tech); font-size: 0.8rem; color: #00d2ff; }
        .plan-arrow { font-size: 0.7rem; opacity: 0.5; transition: 0.3s; }
        .plan-item.active .plan-arrow { transform: rotate(180deg); color: #00d2ff; opacity: 1; }
        .plan-title { font-weight: bold; margin: 4px 0 0; font-size: 0.95rem; }

        .plan-body { 
            display: none; padding-top: 0.8rem; margin-top: 0.5rem; 
            border-top: 1px dashed rgba(255,255,255,0.2); animation: fadeIn 0.3s;
        }
        .plan-item.active .plan-body { display: block; }
        .plan-note { 
            font-size: 0.85rem; color: var(--text-sub); margin-bottom: 0.8rem; line-height: 1.5; white-space: pre-wrap; 
            word-break: break-word; overflow-wrap: anywhere; 
        }
        .plan-btns { display: flex; gap: 8px; justify-content: flex-end; }
        
        .p-btn { border: none; font-size: 0.75rem; padding: 6px 12px; border-radius: 4px; cursor: pointer; transition:0.2s; font-family:sans-serif; display: inline-flex; align-items: center; gap: 4px; }
        .p-btn-rec { background: rgba(0, 210, 255, 0.15); color: #b3f0ff; border: 1px solid rgba(0, 210, 255, 0.4); }
        .p-btn-rec:hover { background: rgba(0, 210, 255, 0.3); color: #fff; box-shadow: 0 0 10px rgba(0,210,255,0.2); }
        
        /* å‰Šé™¤ãƒœã‚¿ãƒ³ (ãƒ—ãƒ©ãƒ³ç”¨) - ç›®ç«‹ã¤ã‚ˆã†ã« */
        .p-btn-del { 
            background: rgba(255, 94, 94, 0.15); 
            color: #ff8888; 
            border: 1px solid rgba(255, 94, 94, 0.4); 
        }
        .p-btn-del:hover { 
            background: rgba(255, 94, 94, 0.3); 
            color: #fff; 
            border-color: #ff5e5e; 
            box-shadow: 0 0 10px rgba(255, 94, 94, 0.2); 
        }

        /* --- å³: ãƒ­ã‚°ãƒ•ã‚£ãƒ¼ãƒ‰ --- */
        .page-heading {
            font-family: 'Shippori Mincho', serif; 
            font-size: 1.8rem; 
            color: rgba(255,255,255,0.95);
            position: sticky; top: 0; z-index: 10;
            background: transparent; 
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            margin: 0 0 1.5rem 0; padding: 1rem 0;
            border-bottom: 1px solid rgba(255,255,255,0.15);
            text-shadow: 0 2px 10px rgba(0,0,0,0.8);
            display: flex; justify-content: space-between; align-items: center;
        }
        
        /* ãƒ­ã‚°è¿½åŠ ãƒœã‚¿ãƒ³ */
        .btn-add-log {
            background: linear-gradient(135deg, rgba(212, 175, 55, 0.2), rgba(180, 140, 30, 0.4));
            border: 1px solid var(--accent-gold);
            color: #ffe; 
            padding: 0.7rem 1.5rem; border-radius: 30px;
            font-size: 0.95rem; font-weight: bold; 
            cursor: pointer; transition: all 0.3s;
            font-family: var(--font-main); display: flex; align-items: center; gap: 8px;
            box-shadow: 0 0 15px rgba(212, 175, 55, 0.2);
            text-shadow: 0 0 5px rgba(212, 175, 55, 0.5);
        }
        .btn-add-log:hover { 
            background: linear-gradient(135deg, rgba(212, 175, 55, 0.4), rgba(180, 140, 30, 0.6));
            box-shadow: 0 0 25px rgba(212, 175, 55, 0.5); 
            color: #fff;
            transform: translateY(-2px);
        }

        /* ãƒ•ã‚£ãƒ¼ãƒ‰ã‚«ãƒ¼ãƒ‰ */
        .feed-card {
            margin-bottom: 2rem;
            display: grid; grid-template-columns: 200px 1fr;
            overflow: hidden; 
            animation: slideIn 0.4s ease forwards;
            cursor: default;
            /* ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆæ ç·š */
            border-left: 4px solid rgba(212, 175, 55, 0.3);
            border-color: rgba(255, 255, 255, 0.1);
            transition: all 0.3s;
        }
        .feed-card:hover { 
            transform: translateY(-3px);
            /* ãƒ›ãƒãƒ¼æ™‚ï¼šé®®ã‚„ã‹ãªé‡‘è‰²ã®æ ç·šã¨ç™ºå…‰ */
            border-left-color: var(--accent-gold);
            border-color: rgba(212, 175, 55, 0.4);
            box-shadow: 0 5px 25px rgba(212, 175, 55, 0.15);
        }

        .feed-img-col { background: #000; position: relative; min-height: 180px; border-right: 1px solid rgba(255,255,255,0.1); }
        .feed-img { width: 100%; height: 100%; object-fit: cover; opacity: 0.9; transition: transform 0.5s; }
        .feed-card:hover .feed-img { transform: scale(1.05); opacity: 1; }
        .feed-no-img { display: flex; align-items: center; justify-content: center; height: 100%; font-size: 3rem; color: rgba(255,255,255,0.1); }

        .feed-date-badge {
            position: absolute; top: 0; left: 0;
            background: rgba(212, 175, 55, 0.9); color: #000;
            padding: 4px 10px; font-family: var(--font-tech); font-weight: bold; font-size: 0.85rem;
        }

        .feed-content { padding: 1.5rem; display: flex; flex-direction: column; }
        
        .feed-head { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.5rem; }
        .feed-title { 
            font-size: 1.5rem; margin: 0; font-weight: 500; font-family: 'Shippori Mincho';
            color: #fff; text-shadow: 0 2px 5px rgba(0,0,0,0.5);
        }
        .feed-stars { color: var(--accent-gold); letter-spacing: 2px; font-size: 1.1rem; }

        .feed-meta { font-size: 0.8rem; color: var(--text-sub); margin-bottom: 1rem; display: flex; gap: 10px; align-items: center; }
        .meta-tag { 
            color: var(--accent-gold); border: 1px solid rgba(212,175,55,0.3); 
            padding: 2px 8px; border-radius: 4px; font-size: 0.7rem; background: rgba(212,175,55,0.05);
        }

        /* æ„Ÿæƒ³ãƒ†ã‚­ã‚¹ãƒˆ */
        .feed-text { 
            font-size: 1rem; line-height: 1.7; color: #e0e0e0; flex-grow: 1; 
            border-top: 1px solid rgba(255,255,255,0.1); padding-top: 1rem; margin-top: 0.5rem;
            word-break: break-word; overflow-wrap: anywhere; 
        }
        .text-short { display: block; }
        .text-full { display: none; }
        .read-more-btn { 
            color: var(--accent-gold); font-size: 0.8rem; cursor: pointer; margin-top: 0.5rem; 
            display: inline-block; opacity: 0.8;
        }
        .read-more-btn:hover { text-decoration: underline; opacity: 1; }

        .feed-foot { text-align: right; margin-top: 1rem; }
        
        /* å‰Šé™¤ãƒœã‚¿ãƒ³ (ãƒ­ã‚°ç”¨) - èµ¤è‰²ã‚’å¼·èª¿ */
        .btn-del-log { 
            background: rgba(255, 94, 94, 0.15); 
            border: 1px solid rgba(255, 94, 94, 0.4); 
            color: #ff8888; 
            font-size: 0.85rem; padding: 8px 16px; border-radius: 4px;
            cursor: pointer; transition: 0.2s;
            display: inline-flex; align-items: center; gap: 6px;
            font-weight: 500;
        }
        .btn-del-log:hover { 
            background: rgba(255, 94, 94, 0.3); 
            color: #fff; 
            border-color: #ff5e5e; 
            box-shadow: 0 0 10px rgba(255, 94, 94, 0.3); 
        }

        /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ– */
        @media (max-width: 900px) {
            body { overflow: auto; height: auto; }
            .dashboard-container { display: block; height: auto; padding: 6rem 1rem 2rem; }
            .left-column { height: auto; overflow: visible; margin-bottom: 3rem; padding: 0; }
            .right-column { height: auto; overflow: visible; padding: 0; }
            .feed-card { grid-template-columns: 1fr; }
            .feed-img-col { height: 200px; border-right: none; border-bottom: 1px solid rgba(255,255,255,0.1); }
            .page-heading { position: static; background: transparent; backdrop-filter: none; }
        }

        /* --- ãƒ¢ãƒ¼ãƒ€ãƒ« (ãƒ‡ã‚¶ã‚¤ãƒ³çµ±ä¸€) --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(5, 8, 15, 0.85); backdrop-filter: blur(10px);
            z-index: 999; display: none; align-items: center; justify-content: center;
        }
        .modal-box {
            background: rgba(20, 25, 35, 0.95);
            border: 1px solid var(--accent-gold);
            width: 90%; max-width: 500px; padding: 2.5rem; border-radius: 12px;
            position: relative; 
            box-shadow: 0 0 50px rgba(0,0,0,0.8), 0 0 15px rgba(212, 175, 55, 0.2);
            transition: border-color 0.3s, box-shadow 0.3s;
        }
        .modal-close { 
            position: absolute; top: 1rem; right: 1rem; background:none; border:none; 
            color: #fff; font-size: 1.8rem; cursor: pointer; opacity: 0.6; transition: 0.3s;
        }
        .modal-close:hover { color: var(--accent-gold); opacity: 1; transform: scale(1.1); }
        
        .modal-h { 
            text-align: center; color: var(--accent-gold); margin-bottom: 2rem; 
            font-size: 1.5rem; border-bottom: 1px solid rgba(212, 175, 55, 0.3); 
            padding-bottom: 1rem; font-family: 'Shippori Mincho'; letter-spacing: 0.1em;
            text-shadow: 0 0 10px rgba(212, 175, 55, 0.2);
        }
        
        /* ãƒ—ãƒ©ãƒ³ç”¨ãƒ†ãƒ¼ãƒï¼ˆé’ï¼‰ */
        .modal-box.plan-theme {
            border-color: #00d2ff;
            box-shadow: 0 0 50px rgba(0,0,0,0.8), 0 0 15px rgba(0, 210, 255, 0.2);
        }
        .modal-box.plan-theme .modal-h {
            color: #00d2ff;
            border-bottom-color: rgba(0, 210, 255, 0.3);
            text-shadow: 0 0 10px rgba(0, 210, 255, 0.2);
        }
        .modal-box.plan-theme .modal-close:hover { color: #00d2ff; }
        
        .form-grp { margin-bottom: 1.5rem; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
        label { display: block; font-size: 0.85rem; color: #ccc; margin-bottom: 0.5rem; letter-spacing: 0.05em; font-family: var(--font-tech); }
        
        /* ãƒ•ã‚©ãƒ¼ãƒ å…¥åŠ›è¦ç´ ã®çµ±ä¸€ */
        input[type="text"], input[type="date"], input[type="password"], input[type="email"], select, textarea {
            width: 100%; box-sizing: border-box;
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #fff; padding: 0.8rem; border-radius: 6px;
            font-size: 1rem; font-family: sans-serif;
            transition: all 0.3s;
        }
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--accent-gold);
            box-shadow: 0 0 10px rgba(212, 175, 55, 0.2);
            background: rgba(0, 0, 0, 0.6);
        }
        /* ãƒ—ãƒ©ãƒ³ç”¨ãƒ•ã‚©ãƒ¼ã‚«ã‚¹è‰² */
        .modal-box.plan-theme input:focus, 
        .modal-box.plan-theme textarea:focus {
            border-color: #00d2ff;
            box-shadow: 0 0 10px rgba(0, 210, 255, 0.2);
        }

        ::placeholder { color: rgba(255, 255, 255, 0.3); }

        /* ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒªã‚¢ */
        #upload-box {
            border: 1px dashed rgba(255, 255, 255, 0.3);
            border-radius: 6px; padding: 2rem; text-align: center;
            background: rgba(255, 255, 255, 0.03);
            cursor: pointer; transition: 0.3s;
        }
        #upload-box:hover {
            border-color: var(--accent-gold);
            background: rgba(212, 175, 55, 0.05);
        }

        /* ãƒ¢ãƒ¼ãƒ€ãƒ«ç”¨ãƒœã‚¿ãƒ³ */
        .btn-modal-action {
            width: 100%; padding: 12px; border-radius: 30px; border: none;
            background: linear-gradient(135deg, var(--accent-gold), #b8860b);
            color: #000; font-weight: bold; font-size: 1rem; cursor: pointer;
            transition: 0.3s; font-family: var(--font-tech);
            box-shadow: 0 4px 15px rgba(212, 175, 55, 0.3);
        }
        .btn-modal-action:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(212, 175, 55, 0.5);
        }
        /* é’è‰²ãƒœã‚¿ãƒ³ (ãƒ—ãƒ©ãƒ³ç”¨) */
        .btn-modal-action.plan-mode {
            background: linear-gradient(135deg, #00d2ff, #0077ff);
            box-shadow: 0 4px 15px rgba(0, 210, 255, 0.3);
            color: #fff;
        }
        .btn-modal-action.plan-mode:hover {
            box-shadow: 0 6px 20px rgba(0, 210, 255, 0.5);
        }

        .loading { text-align: center; padding: 3rem; opacity: 0.6; font-family: var(--font-tech); font-size: 1.2rem; }
        @keyframes slideIn { to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeIn { from { opacity:0; transform:translateY(-5px); } to { opacity:1; transform:translateY(0); } }
    </style>
</head>
<body>

    <div class="menu-container">
        <button id="menu-toggle" class="menu-toggle" aria-label="ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é–‹ã">
            <span class="line"></span><span class="line"></span><span class="line"></span>
        </button>
        <nav id="nav-overlay" class="nav-overlay">
            <ul class="nav-list">
                <li><a href="index.html" class="nav-link">ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸<span>Home</span></a></li>
                <li><a href="stars.html" class="nav-link">æ˜Ÿã‚’æ¢ã™<span>Star Chart</span></a></li>
                <li><a href="events.html" class="nav-link">æ˜Ÿç©ºæƒ…å ±å±€<span>Sky Events</span></a></li>
                <li><a href="theater.html" class="nav-link">å®‡å®™ã‚·ã‚¢ã‚¿ãƒ¼<span>Space Theater</span></a></li>
                <li><a href="lifelog.html" class="nav-link">æ˜Ÿç©ºãƒ©ã‚¤ãƒ•ãƒ­ã‚°<span>My Starry Sky Log</span></a></li>
            </ul>
        </nav>
    </div>

    <header class="common-header">
        <a href="index.html" class="header-back-btn">ãƒˆãƒƒãƒ—ã¸æˆ»ã‚‹</a>
        <h1 class="page-title">æ˜Ÿç©ºãƒ©ã‚¤ãƒ•ãƒ­ã‚°<span>My Starry Sky Log</span></h1>
    </header>

    <div class="dashboard-container" id="app-container" style="display:none;">
        
        <aside class="left-column">
            <div class="smart-card profile-panel">
                <button class="btn-edit-profile" onclick="openProfileModal()">âš™ï¸</button>
                
                <div class="avatar-circle">
                    <img id="avatar-img" src="" style="display:none;">
                    <span id="avatar-default" class="avatar-default">ğŸ”­</span>
                </div>
                <h2 id="display-name" class="user-name">Guest User</h2>
                <div id="display-email-sub" class="user-email">guest@example.com</div>
                
                <div class="stats-row">
                    <div class="stat-item log-theme">
                        <div class="stat-val" id="stat-total">0</div>
                        <div class="stat-label">LOGS</div>
                    </div>
                    <div class="stat-item plan-theme">
                        <div class="stat-val" id="stat-plans">0</div>
                        <div class="stat-label">PLANS</div>
                    </div>
                </div>
            </div>

            <div class="action-panel">
                <button class="btn-plan" onclick="openModal('plan')">
                    ğŸ“… ãƒ—ãƒ©ãƒ³ã‚’ç«‹ã¦ã‚‹
                </button>
            </div>

            <div class="smart-card">
                <div class="panel-header">
                    <div class="panel-title">è¦³æ¸¬äºˆå®š -PLANS-</div>
                </div>
                <div id="plans-list" class="wishlist-container">
                    <p style="opacity:0.4; font-size:0.8rem; text-align:center; padding:1rem;">äºˆå®šã¯ã‚ã‚Šã¾ã›ã‚“</p>
                </div>
            </div>
        </aside>

        <main class="right-column">
            <div class="page-heading">
                <span>æ˜Ÿç©ºæ—¥èªŒ - LOGS -</span>
                <button class="btn-add-log" onclick="openModal('log')">ï¼‹ æ˜Ÿç©ºæ—¥èªŒã‚’æ›¸ã</button>
            </div>
            <div id="logs-list">
                <div class="loading">Loading...</div>
            </div>
        </main>
    </div>

    <div id="auth-overlay" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(5,10,20,0.95); z-index:2000; display:flex; align-items:center; justify-content:center; backdrop-filter:blur(10px);">
        <div id="view-login" class="modal-box">
            <h2 class="modal-h" style="margin-bottom:1.5rem;">LOGIN</h2>
            <p id="login-error" style="color:#ff5555; font-size:0.8rem; min-height:1em;"></p>
            <input type="email" id="login-email" placeholder="ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹" style="margin-bottom:1rem;">
            <input type="password" id="login-pass" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰" style="margin-bottom:1rem;">
            <button onclick="signIn()" class="btn-modal-action">ãƒ­ã‚°ã‚¤ãƒ³</button>
            <div style="margin-top:1rem; font-size:0.9rem; cursor:pointer; color:#d4af37; text-decoration:underline; text-align:center;" onclick="switchView('signup')">æ–°è¦ç™»éŒ²ã¯ã“ã¡ã‚‰</div>
        </div>
        <div id="view-signup" style="display:none;" class="modal-box">
            <h2 class="modal-h" style="margin-bottom:1.5rem;">SIGN UP</h2>
            <p id="signup-error" style="color:#ff5555; font-size:0.8rem;"></p>
            <input type="email" id="signup-email" placeholder="ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹" style="margin-bottom:1rem;">
            <input type="password" id="signup-pass" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰" style="margin-bottom:1rem;">
            <button onclick="signUp()" class="btn-modal-action">èªè¨¼ã‚³ãƒ¼ãƒ‰ã‚’é€ä¿¡</button>
            <div style="margin-top:1rem; font-size:0.9rem; cursor:pointer; color:#d4af37; text-decoration:underline; text-align:center;" onclick="switchView('login')">æˆ»ã‚‹</div>
        </div>
        <div id="view-verify" style="display:none;" class="modal-box">
            <h2 class="modal-h" style="margin-bottom:1.5rem;">VERIFY</h2>
            <p style="color:#ccc; font-size:0.8rem; margin-bottom:1rem;">ãƒ¡ãƒ¼ãƒ«ã«å±Šã„ãŸèªè¨¼ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</p>
            <p id="verify-error" style="color:#ff5555; font-size:0.8rem;"></p>
            <input type="text" id="verify-code" placeholder="èªè¨¼ã‚³ãƒ¼ãƒ‰" style="margin-bottom:1rem;">
            <button onclick="verifyCode()" class="btn-modal-action">èªè¨¼ã™ã‚‹</button>
        </div>
    </div>

    <div id="modal-overlay" class="modal-overlay">
        <div class="modal-box">
            <button class="modal-close" onclick="closeModal()">Ã—</button>
            <h3 class="modal-h" id="modal-heading">è¨˜éŒ²ã‚’ä½œæˆ</h3>

            <form id="unified-form">
                <input type="hidden" id="input-type" value="log">
                
                <div class="form-row form-grp">
                    <div>
                        <label>æ—¥ä»˜</label>
                        <input type="date" id="input-date" required>
                    </div>
                    <div>
                        <label>å¯¾è±¡ / ã‚¿ã‚¤ãƒˆãƒ«</label>
                        <input type="text" id="input-target" placeholder="ä¾‹: ã‚ªãƒªã‚ªãƒ³åº§" required>
                    </div>
                </div>

                <div id="log-fields">
                    <div class="form-row form-grp">
                        <div>
                            <label>æ©Ÿæ</label>
                            <select id="input-tool">
                                <option>è‚‰çœ¼</option><option>åŒçœ¼é¡</option><option>å¤©ä½“æœ›é é¡</option><option>ã‚«ãƒ¡ãƒ©</option>
                            </select>
                        </div>
                        <div>
                            <label>è©•ä¾¡</label>
                            <select id="input-rating">
                                <option value="5">â˜…â˜…â˜…â˜…â˜…</option><option value="4">â˜…â˜…â˜…â˜…â˜†</option><option value="3">â˜…â˜…â˜…â˜†â˜†</option><option value="2">â˜…â˜…â˜†â˜†â˜†</option><option value="1">â˜…â˜†â˜†â˜†â˜†</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-grp">
                        <label>å†™çœŸ (1æšã®ã¿)</label>
                        <div id="upload-box" onclick="document.getElementById('input-file').click()">
                            <span style="font-size:0.9rem; opacity:0.8;">ğŸ“· ã‚¯ãƒªãƒƒã‚¯ã—ã¦å†™çœŸã‚’é¸æŠ</span>
                            <input type="file" id="input-file" accept="image/*" style="display:none" onchange="previewImage(this)">
                        </div>
                        <div id="preview-area" style="display:none; position:relative; text-align:center;">
                            <img id="preview-img-tag" style="max-width:100%; max-height:200px; border:1px solid rgba(255,255,255,0.3); border-radius:4px;">
                            <button type="button" onclick="clearImage()" style="position:absolute; top:-10px; right:-10px; background:#cc4444; color:#fff; border:none; width:24px; height:24px; border-radius:50%; cursor:pointer;">Ã—</button>
                        </div>
                    </div>
                </div>

                <div class="form-grp">
                    <label id="label-comment">ãƒ¡ãƒ¢ãƒ»æ„Ÿæƒ³</label>
                    <textarea id="input-comment" rows="4"></textarea>
                </div>

                <button type="submit" class="btn-modal-action" id="btn-save">ä¿å­˜ã™ã‚‹</button>
            </form>
        </div>
    </div>

    <div id="profile-modal" class="modal-overlay">
        <div class="modal-box">
            <button class="modal-close" onclick="closeProfileModal()">Ã—</button>
            <h3 class="modal-h">ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç·¨é›†</h3>
            
            <form id="profile-form">
                <div style="text-align:center; margin-bottom:2rem;">
                    <div style="width:100px; height:100px; border-radius:50%; border:2px solid var(--accent-gold); margin:0 auto; overflow:hidden; position:relative; cursor:pointer; background:#000;" onclick="document.getElementById('input-avatar-file').click()">
                        <img id="profile-preview" src="" style="width:100%; height:100%; object-fit:cover; display:none;">
                        <span id="profile-preview-default" style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); font-size:2rem; opacity:0.5;">ğŸ“·</span>
                    </div>
                    <p style="font-size:0.7rem; margin-top:0.5rem; opacity:0.6;">ã‚¿ãƒƒãƒ—ã—ã¦ç”»åƒã‚’å¤‰æ›´</p>
                    <input type="file" id="input-avatar-file" accept="image/*" style="display:none" onchange="previewProfileImage(this)">
                </div>

                <div class="form-grp">
                    <label>è¡¨ç¤ºå</label>
                    <input type="text" id="input-display-name" required>
                </div>

                <button type="submit" class="btn-modal-action">å¤‰æ›´ã‚’ä¿å­˜</button>
            </form>
        </div>
    </div>

    <script src="assets/js/script.js"></script>
    <script>
        // â–¼â–¼â–¼ è¨­å®šã‚¨ãƒªã‚¢ â–¼â–¼â–¼
        const API_URL = "https://ef7yxsmrds7qxjopbqyg5x6omm0uaomt.lambda-url.ap-northeast-1.on.aws/";
        const COGNITO_REGION = 'ap-northeast-1';
        const USER_POOL_ID = 'ap-northeast-1_kXEnG6ST0'; 
        const CLIENT_ID = '1fsbv088bo29u6ob8gaavn4jll'; 
        // â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²

        const { Auth } = aws_amplify;
        aws_amplify.Amplify.configure({
            Auth: { region: COGNITO_REGION, userPoolId: USER_POOL_ID, userPoolWebClientId: CLIENT_ID }
        });

        let currentSession = null;
        let selectedImageBase64 = null; 
        let profileImageBase64 = null;  
        let allData = []; 
        let convertingPlanId = null;

        document.querySelector('.dashboard-container').addEventListener('mousemove', (e) => {
            const cards = document.querySelectorAll('.smart-card, .feed-card');
            cards.forEach(card => {
                const rect = card.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                card.style.setProperty('--mouse-x', `${x}px`);
                card.style.setProperty('--mouse-y', `${y}px`);
            });
        });

        checkUser();

        async function checkUser() {
            try {
                const user = await Auth.currentAuthenticatedUser();
                currentSession = await Auth.currentSession();
                showDashboard(user);
            } catch (err) {
                document.getElementById('auth-overlay').style.display = 'flex';
            }
        }

        function showDashboard(user) {
            document.getElementById('auth-overlay').style.display = 'none';
            document.getElementById('app-container').style.display = 'grid';
            const email = user.attributes.email;
            document.getElementById('display-email-sub').textContent = email;
            document.getElementById('display-name').textContent = email.split('@')[0];
            fetchData();
        }

        async function fetchData() {
            try {
                const token = currentSession.getAccessToken().getJwtToken();
                const res = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'load', token: token })
                });
                const data = await res.json();
                allData = data.logs || [];
                renderAll();
            } catch(e) { console.error(e); }
        }

        function renderAll() {
            // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«
            const profile = allData.find(d => d.logId === 'profile' || d.type === 'profile');
            if (profile) {
                if(profile.target) document.getElementById('display-name').textContent = profile.target;
                if(profile.imageUrl) {
                    document.getElementById('avatar-img').src = profile.imageUrl;
                    document.getElementById('avatar-img').style.display = 'block';
                    document.getElementById('avatar-default').style.display = 'none';
                }
            }

            const logs = allData.filter(d => d.type !== 'plan' && d.type !== 'profile' && d.logId !== 'profile');
            const plans = allData.filter(d => d.type === 'plan');

            document.getElementById('stat-total').textContent = logs.length;
            document.getElementById('stat-plans').textContent = plans.length;

            // ãƒ­ã‚°ãƒªã‚¹ãƒˆ
            const logsContainer = document.getElementById('logs-list');
            logsContainer.innerHTML = '';
            if(logs.length === 0) {
                logsContainer.innerHTML = '<div style="text-align:center; opacity:0.3; padding:3rem;">è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</div>';
            } else {
                logs.forEach((log, i) => {
                    const d = new Date(log.date);
                    const dateStr = `${d.getFullYear()}.${(d.getMonth()+1).toString().padStart(2,'0')}.${d.getDate().toString().padStart(2,'0')}`;
                    const stars = "â˜…".repeat(parseInt(log.rating||0));
                    
                    let thumbHtml = `<div class="log-no-img">ğŸ”­</div>`;
                    if(log.imageUrl) thumbHtml = `<img src="${log.imageUrl}" class="feed-img">`;

                    // æ„Ÿæƒ³ã®é•·ã•åˆ¤å®š (80æ–‡å­—ä»¥ä¸Šãªã‚‰çœç•¥)
                    const comment = log.comment || '';
                    const MAX_LEN = 80;
                    let commentHtml = '';
                    
                    if (comment.length > MAX_LEN) {
                        const shortText = escapeHtml(comment.substr(0, MAX_LEN)) + '...';
                        const fullText = escapeHtml(comment).replace(/\n/g, '<br>');
                        commentHtml = `
                            <span class="text-short">${shortText}</span>
                            <span class="text-full" style="display:none;">${fullText}</span>
                            <span class="read-more-btn" onclick="toggleComment(this)">ç¶šã â‰«</span>
                        `;
                    } else {
                        commentHtml = escapeHtml(comment).replace(/\n/g, '<br>');
                    }

                    const html = `
                        <div class="smart-card feed-card" style="animation-delay:${i*0.1}s">
                            <div class="feed-img-col">
                                ${thumbHtml}
                                <div class="feed-date-badge">${dateStr}</div>
                            </div>
                            <div class="feed-content">
                                <div class="feed-head">
                                    <h3 class="feed-title">${escapeHtml(log.target)}</h3>
                                    <span class="feed-stars">${stars}</span>
                                </div>
                                <div class="feed-meta">
                                    <span class="meta-tag">æ©Ÿæ: ${escapeHtml(log.tool)}</span>
                                </div>
                                <div class="feed-text">${commentHtml}</div>
                                <div class="feed-foot">
                                    <button class="btn-del-log" onclick="deleteItem('${log.logId}', '${log.imageUrl||''}')">ğŸ—‘ å‰Šé™¤</button>
                                </div>
                            </div>
                        </div>
                    `;
                    logsContainer.insertAdjacentHTML('beforeend', html);
                });
            }

            // äºˆå®šãƒªã‚¹ãƒˆ (ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³)
            const plansContainer = document.getElementById('plans-list');
            plansContainer.innerHTML = '';
            if(plans.length === 0) {
                plansContainer.innerHTML = '<p style="opacity:0.4; font-size:0.8rem; text-align:center; padding:1rem;">äºˆå®šã¯ã‚ã‚Šã¾ã›ã‚“</p>';
            } else {
                plans.forEach(plan => {
                    const d = new Date(plan.date);
                    const dateStr = `${d.getMonth()+1}/${d.getDate()}`;
                    
                    const html = `
                        <div class="plan-item" onclick="togglePlan(this)">
                            <div class="plan-head">
                                <div>
                                    <span class="plan-date">${dateStr}</span>
                                    <span style="margin:0 8px; opacity:0.3;">|</span>
                                    <span class="plan-title">${escapeHtml(plan.target)}</span>
                                </div>
                                <div class="plan-arrow">â–¼</div>
                            </div>
                            <div class="plan-body" onclick="event.stopPropagation()">
                                <div class="plan-note">${escapeHtml(plan.comment || 'ãƒ¡ãƒ¢ãªã—')}</div>
                                <div class="plan-btns">
                                    <button class="p-btn p-btn-rec" onclick="initiateConvert('${plan.logId}')">ğŸ“ è¨˜éŒ²ã—ã¦å®Œäº†</button>
                                    <button class="p-btn p-btn-del" onclick="deleteItem('${plan.logId}', null)">ğŸ—‘ å‰Šé™¤</button>
                                </div>
                            </div>
                        </div>
                    `;
                    plansContainer.insertAdjacentHTML('beforeend', html);
                });
            }
        }
        
        function togglePlan(el) { el.classList.toggle('active'); }

        // æ„Ÿæƒ³ã®å±•é–‹/æŠ˜ã‚Šç•³ã¿
        function toggleComment(btn) {
            const parent = btn.parentElement;
            const short = parent.querySelector('.text-short');
            const full = parent.querySelector('.text-full');
            
            if (short.style.display !== 'none') {
                short.style.display = 'none';
                full.style.display = 'block';
                btn.textContent = 'â‰ª é–‰ã˜ã‚‹';
            } else {
                short.style.display = 'inline';
                full.style.display = 'none';
                btn.textContent = 'ç¶šã â‰«';
            }
        }

        async function saveItem(dataObj, customId) {
            const token = currentSession.getAccessToken().getJwtToken();
            const body = { action: 'save', token: token, logData: dataObj };
            if(customId) body.logId = customId;
            const res = await fetch(API_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
            return await res.json();
        }

        async function deleteItem(logId, imageUrl, skip) {
            if(!skip && !confirm("å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
            try {
                const token = currentSession.getAccessToken().getJwtToken();
                await fetch(API_URL, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'delete', token: token, logId: logId, logData: { imageUrl: imageUrl } })
                });
                fetchData();
            } catch(e) { alert("Error: "+e.message); }
        }

        function initiateConvert(planId) {
            const plan = allData.find(d => d.logId === planId);
            if(!plan) return;
            convertingPlanId = planId; 
            openModal('log');
            document.getElementById('input-date').value = plan.date;
            document.getElementById('input-target').value = plan.target;
            document.getElementById('modal-heading').textContent = "æ—¥èªŒã‚’æ›¸ã";
        }

        // --- Profile ---
        function openProfileModal() {
            document.getElementById('profile-modal').style.display = 'flex';
            document.getElementById('input-display-name').value = document.getElementById('display-name').textContent;
            const currentSrc = document.getElementById('avatar-img').src;
            const preview = document.getElementById('profile-preview');
            if(document.getElementById('avatar-img').style.display !== 'none') {
                preview.src = currentSrc; preview.style.display = 'block';
                document.getElementById('profile-preview-default').style.display = 'none';
            }
        }
        function closeProfileModal() { document.getElementById('profile-modal').style.display = 'none'; profileImageBase64 = null; }

        function previewProfileImage(input) {
            processImage(input, (b64) => {
                profileImageBase64 = b64;
                document.getElementById('profile-preview').src = b64;
                document.getElementById('profile-preview').style.display = 'block';
                document.getElementById('profile-preview-default').style.display = 'none';
            });
        }

        document.getElementById('profile-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = e.target.querySelector('button'); btn.disabled=true; btn.textContent="ä¿å­˜ä¸­...";
            const name = document.getElementById('input-display-name').value;
            const dataObj = { type: 'profile', target: name, imageBase64: profileImageBase64 };
            const curr = allData.find(d => d.logId === 'profile');
            if(curr && !profileImageBase64) dataObj.imageUrl = curr.imageUrl;

            try {
                await saveItem(dataObj, 'profile');
                closeProfileModal(); fetchData();
            } catch(e){ alert(e.message); }
            finally { btn.disabled=false; btn.textContent="å¤‰æ›´ã‚’ä¿å­˜"; }
        });

        // --- Main Modal ---
        function openModal(type) {
            const modalBox = document.querySelector('#modal-overlay .modal-box');
            document.getElementById('modal-overlay').style.display = 'flex';
            document.getElementById('input-date').valueAsDate = new Date();
            
            document.getElementById('input-type').value = type;
            const lf = document.getElementById('log-fields');
            const btn = document.getElementById('btn-save');
            const lbl = document.getElementById('label-comment');
            const h = document.getElementById('modal-heading');
            
            if(type !== 'log') convertingPlanId = null; 

            if(type === 'plan') {
                modalBox.classList.add('plan-theme');
                h.textContent = "ãƒ—ãƒ©ãƒ³ã‚’è¿½åŠ "; lf.style.display = 'none'; lbl.textContent = "ãƒ¡ãƒ¢"; btn.textContent = "è¿½åŠ ";
                btn.className = "btn-modal-action plan-mode"; 
                document.getElementById('input-date').required = false; 
            } else {
                modalBox.classList.remove('plan-theme');
                h.textContent = "æ—¥èªŒã‚’æ›¸ã"; lf.style.display = 'block'; lbl.textContent = "æ„Ÿæƒ³"; btn.textContent = "ä¿å­˜";
                btn.className = "btn-modal-action"; 
                document.getElementById('input-date').required = true;
            }
        }
        function closeModal() {
            document.getElementById('modal-overlay').style.display = 'none';
            document.getElementById('unified-form').reset();
            convertingPlanId = null; clearImage();
        }

        function processImage(input, cb) {
            if(!input.files[0]) return;
            const r = new FileReader();
            r.onload = (e) => {
                const i = new Image();
                i.onload = () => {
                    const c = document.createElement('canvas');
                    const x = c.getContext('2d');
                    const M = 800;
                    let w=i.width, h=i.height;
                    if(w>M){ h*=M/w; w=M; }
                    c.width=w; c.height=h;
                    x.drawImage(i,0,0,w,h);
                    cb(c.toDataURL('image/jpeg',0.7));
                };
                i.src = e.target.result;
            };
            r.readAsDataURL(input.files[0]);
        }

        function previewImage(inp) { processImage(inp, (b64) => { selectedImageBase64 = b64; document.getElementById('upload-box').style.display='none'; document.getElementById('preview-area').style.display='block'; document.getElementById('preview-img-tag').src=b64; }); }
        function clearImage() { document.getElementById('input-file').value=""; selectedImageBase64=null; document.getElementById('upload-box').style.display='block'; document.getElementById('preview-area').style.display='none'; }

        document.getElementById('unified-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('btn-save'); btn.disabled=true; btn.textContent="é€ä¿¡ä¸­...";
            const type = document.getElementById('input-type').value;
            const data = { type, date: document.getElementById('input-date').value, target: document.getElementById('input-target').value, comment: document.getElementById('input-comment').value };
            if(type === 'log') {
                data.tool = document.getElementById('input-tool').value;
                data.rating = document.getElementById('input-rating').value;
                data.imageBase64 = selectedImageBase64;
            }
            try {
                await saveItem(data);
                if(convertingPlanId) await deleteItem(convertingPlanId, null, true);
                closeModal(); fetchData();
            } catch(e) { alert(e.message); }
            finally { btn.disabled=false; btn.textContent="ä¿å­˜"; }
        });

        function escapeHtml(s) { return s ? s.replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','':'&quot;','\'':'&#039;'}[m])) : ""; }
        function switchView(n){document.querySelectorAll('#auth-overlay > div').forEach(e=>e.style.display='none'),document.getElementById(`view-${n}`).style.display='block'}
        async function signIn(){try{await Auth.signIn(document.getElementById('login-email').value,document.getElementById('login-pass').value),checkUser()}catch(e){document.getElementById('login-error').textContent=e.message}}
        async function signUp(){try{let e=document.getElementById('signup-email').value;await Auth.signUp({username:e,password:document.getElementById('signup-pass').value,attributes:{email:e}}),switchView('verify')}catch(e){document.getElementById('signup-error').textContent=e.message}}
        async function verifyCode(){try{await Auth.confirmSignUp(document.getElementById('signup-email').value,document.getElementById('verify-code').value),alert("OK"),switchView('login')}catch(e){document.getElementById('verify-error').textContent="Error"}}
        async function signOut(){try{await Auth.signOut(),location.reload()}catch(e){}}
    </script>
</body>
</html>