<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ˜Ÿç©ºãƒ©ã‚¤ãƒ•ãƒ­ã‚° - My Starry Sky Log</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Shippori+Mincho:wght@400;500;700&family=Jura:wght@400;600&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="assets/css/base.css">
    <link rel="stylesheet" href="assets/css/pages.css">
    
    <script src="https://unpkg.com/aws-amplify@4.3.43/dist/aws-amplify.min.js"></script>

    <style>
        :root {
            --bg-deep: #080c15; 
            --card-bg: rgba(30, 40, 60, 0.5);
            --card-border: rgba(255, 255, 255, 0.2);
            --font-tech: 'Jura', sans-serif;
            --accent-gold: #d4af37;
            --accent-blue: #00d2ff;
            --header-height: 80px;
            --text-main: #ffffff;
            --text-sub: #d0d0d0;
        }

        body {
            background-color: var(--bg-deep);
            background-image: radial-gradient(circle at 50% 0%, #2a3a55 0%, var(--bg-deep) 80%);
            height: 100vh; overflow: hidden; color: var(--text-main);
        }

        .common-header {
            height: var(--header-height); box-sizing: border-box;
            background: rgba(10, 15, 25, 0.85); backdrop-filter: blur(10px);
            position: absolute; top: 0; left: 0; width: 100%; z-index: 20;
            border-bottom: 1px solid rgba(255,255,255,0.15);
        }

        .dashboard-container {
            max-width: 1300px; margin: 0 auto;
            padding-top: calc(var(--header-height) + 20px);
            padding-bottom: 1rem; padding-left: 2rem; padding-right: 2rem;
            height: 100vh; box-sizing: border-box;
            display: grid; grid-template-columns: 320px 1fr; gap: 2rem; 
            align-items: start; overflow: hidden; 
        }

        .left-column {
            height: 100%; 
            overflow: hidden; 
            display: flex; flex-direction: column; gap: 1rem; 
            padding-bottom: 1rem; 
            padding-right: 0;
        }

        .profile-panel, .action-panel {
            flex-shrink: 0;
        }
        
        #plans-card {
            flex: 1; 
            min-height: 0; 
            display: flex;
            flex-direction: column;
            margin-bottom: 0;
        }

        .right-column { 
            height: 100%; overflow-y: auto; padding: 0 1rem 4rem 0; 
            scrollbar-width: thin; scrollbar-color: rgba(255,255,255,0.3) transparent;
        }
        .right-column::-webkit-scrollbar { width: 6px; }
        .right-column::-webkit-scrollbar-track { background: transparent; }
        .right-column::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.3); border-radius: 3px; }

        .smart-card {
            background: var(--card-bg); border: 1px solid var(--card-border);
            border-radius: 16px; backdrop-filter: blur(12px);
            position: relative; overflow: hidden;
            transition: transform 0.3s ease, border-color 0.3s ease;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        }
        .smart-card:hover { border-color: rgba(255, 255, 255, 0.3); }

        .profile-panel { padding: 1.5rem; text-align: center; }
        
        .btn-edit-profile {
            position: absolute; top: 1rem; right: 1rem;
            background: rgba(255,255,255,0.1); border: none; color: #fff;
            width: 30px; height: 30px; border-radius: 50%; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
        }
        .btn-edit-profile:hover { background: var(--accent-gold); color: #000; }

        .btn-logout {
            position: absolute; top: 1rem; left: 1rem;
            background: transparent; border: 1px solid rgba(255,255,255,0.2);
            color: rgba(255,255,255,0.6); font-size: 0.7rem;
            padding: 4px 8px; border-radius: 4px; cursor: pointer;
            transition: 0.3s; font-family: var(--font-tech);
        }
        .btn-logout:hover {
            background: rgba(255, 80, 80, 0.15); border-color: rgba(255, 80, 80, 0.4); color: #ffaaaa;
        }

        .avatar-circle {
            width: 90px; height: 90px; background: rgba(0,0,0,0.3); border: 2px solid var(--accent-gold);
            border-radius: 50%; margin: 0 auto 1rem; overflow: hidden; display: flex; align-items: center; justify-content: center;
        }
        .avatar-circle img { width: 100%; height: 100%; object-fit: cover; }
        .avatar-default { font-size: 2.5rem; opacity: 0.8; }
        .user-name { font-size: 1.3rem; margin-bottom: 0.2rem; font-weight: 500; font-family: var(--font-main); }
        .user-email { font-size: 0.75rem; color: var(--text-sub); margin-bottom: 1.5rem; font-family: var(--font-tech); }

        .stats-row { 
            display: flex; justify-content: space-between; gap: 12px; margin-top: 1.5rem; 
        }
        .stat-item { 
            flex: 1; 
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            background: rgba(0,0,0,0.2); 
            border-radius: 8px; 
            padding: 12px 6px;
            border: 1px solid rgba(255,255,255,0.1); 
            min-width: 0;
        }
        .stat-item.log-theme { border-color: rgba(212, 175, 55, 0.3); background: linear-gradient(to bottom, rgba(212,175,55,0.05), transparent); }
        .stat-item.plan-theme { border-color: rgba(0, 210, 255, 0.3); background: linear-gradient(to bottom, rgba(0,210,255,0.05), transparent); }
        
        .stat-val { 
            font-family: var(--font-tech); font-size: 1.4rem; line-height: 1.1; margin-bottom: 6px; 
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        .stat-label { 
            font-size: 0.7rem; font-weight: bold; margin: 0; opacity: 0.9; line-height: 1.1; flex-shrink: 0; 
        }

        .stat-item.log-theme .stat-val, 
        .stat-item.log-theme .stat-label { color: var(--accent-gold); }

        .stat-item.plan-theme .stat-val, 
        .stat-item.plan-theme .stat-label { color: #00d2ff; }

        .btn-plan {
            width: 100%; background: linear-gradient(135deg, rgba(0, 210, 255, 0.2), rgba(0, 100, 200, 0.4));
            border: 1px solid rgba(0, 210, 255, 0.5); color: #d0f0ff; padding: 1.2rem; border-radius: 12px;
            font-family: 'Shippori Mincho', serif; font-size: 1.1rem; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px;
        }
        .btn-plan:hover { background: linear-gradient(135deg, rgba(0, 210, 255, 0.4), rgba(0, 100, 200, 0.6)); border-color: #fff; }

        .panel-header { padding: 1.2rem 1.2rem 0.5rem; display: flex; justify-content: space-between; align-items: flex-end; border-bottom: 1px solid rgba(255,255,255,0.1); margin-bottom: 0.5rem; flex-shrink: 0; }
        .panel-title { font-size: 1rem; color: #70d6ff; font-weight: bold; margin: 0; font-family: 'Shippori Mincho', serif; }
        
        .wishlist-container { 
            flex: 1; 
            overflow-y: auto; 
            padding: 0.5rem 0.5rem 1rem 1rem; 
            scrollbar-width: thin; 
            scrollbar-color: rgba(255,255,255,0.3) transparent;
            min-height: 0; 
        }

        .wishlist-container::-webkit-scrollbar { width: 6px; }
        .wishlist-container::-webkit-scrollbar-track { background: rgba(0,0,0,0.1); border-radius: 3px; margin: 5px 0; }
        .wishlist-container::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.2); border-radius: 3px; }
        .wishlist-container::-webkit-scrollbar-thumb:hover { background: rgba(255, 255, 255, 0.4); }

        .plan-item {
            background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.1);
            border-left: 3px solid #00d2ff; padding: 0.8rem; margin-bottom: 0.8rem; border-radius: 4px;
            cursor: pointer; transition: all 0.2s; position: relative;
        }
        .plan-item:hover { background: rgba(255,255,255,0.08); }
        .plan-item.active { background: rgba(0, 210, 255, 0.1); border-color: #00d2ff; }
        .plan-head { display: flex; justify-content: space-between; align-items: center; }
        .plan-date { font-family: var(--font-tech); font-size: 0.8rem; color: #00d2ff; }
        .plan-title { font-weight: bold; margin: 4px 0 0; font-size: 0.95rem; }
        .plan-lock { position: absolute; top:4px; right:4px; font-size:0.7rem; color:rgba(255,255,255,0.3); }
        .plan-arrow { font-size: 0.7rem; opacity: 0.5; transition: 0.3s; }
        .plan-item.active .plan-arrow { transform: rotate(180deg); color: #00d2ff; opacity: 1; }
        
        .plan-body { display: none; padding-top: 0.8rem; margin-top: 0.5rem; border-top: 1px dashed rgba(255,255,255,0.2); }
        .plan-item.active .plan-body { display: block; }
        .plan-btns { display: flex; gap: 8px; justify-content: flex-end; }
        .p-btn { border: none; font-size: 0.75rem; padding: 6px 12px; border-radius: 4px; cursor: pointer; }
        .p-btn-edit { background: rgba(255, 255, 255, 0.1); color: #ddd; border: 1px solid rgba(255, 255, 255, 0.3); }
        .p-btn-rec { background: rgba(0, 210, 255, 0.15); color: #b3f0ff; border: 1px solid rgba(0, 210, 255, 0.4); }
        .p-btn-del { background: rgba(255, 94, 94, 0.15); color: #ff8888; border: 1px solid rgba(255, 94, 94, 0.4); }

        .page-heading {
            position: sticky; top: 0; z-index: 10;
            background: transparent; backdrop-filter: blur(20px);
            margin: 0 0 1.5rem 0; padding: 1rem 10px;
            border-bottom: 1px solid rgba(255,255,255,0.15);
            display: flex; justify-content: space-between; align-items: center;
        }
        
        .tab-group { 
            display: flex; gap: 5px; 
            background: rgba(0, 0, 0, 0.4); 
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 5px;
            border-radius: 30px;
            isolation: isolate; 
        }

        .tab-btn {
            background: transparent; 
            border: none; 
            color: #ffffff;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3); 
            
            font-family: 'Shippori Mincho', serif; 
            font-size: 0.95rem; 
            font-weight: 700;
            cursor: pointer; 
            padding: 10px 20px;
            border-radius: 25px;
            transition: all 0.3s ease;
            
            border-bottom: none !important;
            opacity: 1 !important; 
            filter: none !important;
            
            flex: 1; 
            white-space: nowrap;
            position: relative;
            z-index: 5;
        }

        .tab-btn:hover { 
            background: rgba(255, 255, 255, 0.2);
            color: #fff;
        }
        
        .tab-btn.active::before,
        .tab-btn.active::after,
        .tab-btn::before,
        .tab-btn::after {
            display: none !important;
            content: none !important;
        }

        /* ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ï¼ˆè‡ªåˆ†ãƒ»ã¿ã‚“ãªã®æ—¥èªŒï¼šã‚´ãƒ¼ãƒ«ãƒ‰ï¼‰ */
        .tab-btn.active { 
            background: linear-gradient(135deg, #d4af37, #b8860b) !important; 
            color: #ffffff !important; 
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.4) !important;
            box-shadow: 0 4px 15px rgba(212, 175, 55, 0.4) !important;
            border: 1px solid #ffd700 !important; 
            font-weight: 800;
        }

        /* ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ï¼ˆã¿ã‚“ãªã®è¦³æ¸¬äºˆå®šï¼šãƒ–ãƒ«ãƒ¼ï¼‰ */
        .tab-btn.tab-blue.active { 
            background: linear-gradient(135deg, #00ffff, #0088ff) !important; 
            color: #ffffff !important;
            text-shadow: 0 1px 2px rgba(0,0,0,0.2) !important;
            box-shadow: 0 4px 15px rgba(0, 210, 255, 0.4) !important;
            border: 1px solid #88ffff !important;
        }

        @media (max-width: 600px) {
            .tab-btn {
                font-size: 0.8rem;
                padding: 8px 10px;
            }
        }

        .btn-add-log {
            background: linear-gradient(135deg, rgba(212, 175, 55, 0.2), rgba(180, 140, 30, 0.4));
            border: 1px solid var(--accent-gold); color: #ffe; 
            padding: 0.7rem 1.5rem; border-radius: 30px; font-size: 0.95rem; font-weight: bold; 
            cursor: pointer; font-family: var(--font-main);
        }
        .btn-add-log:hover { background: linear-gradient(135deg, rgba(212, 175, 55, 0.4), rgba(180, 140, 30, 0.6)); }

        .feed-card {
            margin-bottom: 2rem; display: grid; grid-template-columns: 200px 1fr;
            overflow: hidden; animation: slideIn 0.4s ease forwards;
            border-left: 4px solid rgba(212, 175, 55, 0.3); border-color: rgba(255, 255, 255, 0.1);
        }
        .feed-card:hover { transform: translateY(-3px); border-left-color: var(--accent-gold); border-color: rgba(212, 175, 55, 0.4); }
        .feed-img-col { background: #000; position: relative; min-height: 180px; border-right: 1px solid rgba(255,255,255,0.1); }
        .feed-img { width: 100%; height: 100%; object-fit: cover; opacity: 0.9; transition: transform 0.5s; }
        .feed-card:hover .feed-img { transform: scale(1.05); opacity: 1; }
        .feed-no-img { display: flex; align-items: center; justify-content: center; height: 100%; font-size: 3rem; color: rgba(255,255,255,0.1); }
        .feed-date-badge { position: absolute; top: 0; left: 0; background: rgba(212, 175, 55, 0.9); color: #000; padding: 4px 10px; font-family: var(--font-tech); font-weight: bold; font-size: 0.85rem; }
        
        .feed-content { padding: 1.5rem; display: flex; flex-direction: column; }
        .feed-user-info { display: flex; align-items: center; gap: 8px; margin-bottom: 0.5rem; opacity: 0.8; font-size: 0.85rem; color: #aaa; }
        .feed-user-icon { width: 24px; height: 24px; border-radius: 50%; object-fit: cover; border: 1px solid var(--accent-gold); }
        
        .feed-head { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.5rem; }
        .feed-title { font-size: 1.5rem; margin: 0; font-weight: 500; font-family: 'Shippori Mincho'; color: #fff; }
        .feed-stars { color: var(--accent-gold); letter-spacing: 2px; }
        .feed-meta { font-size: 0.8rem; color: var(--text-sub); margin-bottom: 1rem; display: flex; gap: 10px; align-items: center; }
        .meta-tag { color: var(--accent-gold); border: 1px solid rgba(212,175,55,0.3); padding: 2px 8px; border-radius: 4px; font-size: 0.7rem; background: rgba(212,175,55,0.05); }
        .feed-text { font-size: 1rem; line-height: 1.7; color: #e0e0e0; flex-grow: 1; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 1rem; margin-top: 0.5rem; white-space: pre-wrap; word-break: break-word; }
        .feed-foot { text-align: right; margin-top: 1rem; display: flex; justify-content: flex-end; gap: 10px; align-items: center; }
        
        .btn-del-log { background: rgba(255, 94, 94, 0.15); border: 1px solid rgba(255, 94, 94, 0.4); color: #ff8888; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 0.8rem; }
        
        .reaction-group { display: flex; gap: 8px; margin-right: auto; }
        .btn-reaction {
            background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.2); color: #ccc;
            padding: 5px 12px; border-radius: 20px; font-size: 0.8rem; cursor: pointer; transition: 0.3s; display: flex; align-items: center; gap: 5px;
        }
        .btn-reaction:hover { background: rgba(255,255,255,0.1); }
        .btn-reaction.liked { border-color: #ff5577; color: #ff5577; background: rgba(255, 85, 119, 0.1); }
        .btn-reaction.useful { border-color: #ffd700; color: #ffd700; background: rgba(255, 215, 0, 0.1); }

        .reaction-display { display: flex; gap: 10px; margin-right: auto; color: #aaa; font-size: 0.85rem; }
        .reaction-stat { cursor: pointer; display: flex; align-items: center; gap: 4px; transition: color 0.3s; }
        .reaction-stat:hover { color: #fff; text-decoration: underline; }
        .reaction-stat.has-val-like { color: #ff88aa; }
        .reaction-stat.has-val-useful { color: #ffea80; }

        .btn-ref-plan {
            background: linear-gradient(135deg, rgba(0, 210, 255, 0.2), rgba(0, 100, 200, 0.3));
            border: 1px solid rgba(0, 210, 255, 0.5); color: #d0f0ff;
            padding: 6px 15px; border-radius: 20px; font-size: 0.85rem; cursor: pointer; transition: 0.3s;
        }
        .btn-ref-plan:hover { background: rgba(0, 210, 255, 0.4); text-shadow: 0 0 8px #fff; }
        .ref-count { font-size: 0.75rem; color: #aaa; cursor: pointer; text-decoration: underline; margin-right: 10px; align-self: center; }

        .feed-card.plan-type {
            border-left: 4px solid rgba(0, 210, 255, 0.5); 
            background: linear-gradient(90deg, rgba(0, 40, 60, 0.6), rgba(30, 40, 60, 0.5));
        }
        .feed-card.plan-type:hover { border-left-color: #00d2ff; border-color: rgba(0, 210, 255, 0.4); }
        .feed-card.plan-type .feed-date-badge { background: rgba(0, 210, 255, 0.9); }
        .feed-card.plan-type .feed-user-icon { border-color: #00d2ff; }
        .private-mark { color: #aaa; border: 1px solid #555; font-size: 0.6rem; padding: 1px 4px; border-radius: 3px; margin-left: 5px; vertical-align: middle; }

        .feed-card.clickable { cursor: pointer; transition: transform 0.3s, box-shadow 0.3s; }
        .feed-card.clickable:hover { transform: translateY(-5px); box-shadow: 0 10px 30px rgba(0,0,0,0.5); }

        @media (max-width: 900px) {
            body { overflow: auto; height: auto; }
            .dashboard-container { display: block; height: auto; padding: 6rem 1rem 2rem; }
            .left-column { height: auto; margin-bottom: 3rem; }
            .right-column { height: auto; padding: 0; }
            .feed-card { grid-template-columns: 1fr; }
            .feed-img-col { height: 200px; border-right: none; border-bottom: 1px solid rgba(255,255,255,0.1); }
            .page-heading { position: static; background: transparent; backdrop-filter: none; }
        }

        .modal-overlay {
            position: fixed; top: 0; left: 100%; width: 100%; height: 100%;
            background: rgba(5, 8, 15, 0.85); backdrop-filter: blur(10px);
            z-index: 999; display: none; align-items: center; justify-content: center;
        }
        .modal-box {
            background: rgba(20, 25, 35, 0.95); border: 1px solid var(--accent-gold);
            width: 90%; max-width: 500px; padding: 2.5rem; border-radius: 12px; position: relative; 
            box-shadow: 0 0 50px rgba(0,0,0,0.8), 0 0 15px rgba(212, 175, 55, 0.2);
            max-height: 80vh; overflow-y: auto; 
        }
        .modal-close { position: absolute; top: 1rem; right: 1rem; background:none; border:none; color: #fff; font-size: 1.8rem; cursor: pointer; }
        .modal-h { text-align: center; color: var(--accent-gold); margin-bottom: 2rem; font-size: 1.5rem; border-bottom: 1px solid rgba(212, 175, 55, 0.3); padding-bottom: 1rem; font-family: 'Shippori Mincho'; }
        
        .modal-box.plan-theme { border-color: #00d2ff; box-shadow: 0 0 50px rgba(0,0,0,0.8), 0 0 15px rgba(0, 210, 255, 0.2); }
        .modal-box.plan-theme .modal-h { color: #00d2ff; border-bottom-color: rgba(0, 210, 255, 0.3); }

        .form-grp { margin-bottom: 1.5rem; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
        label { display: block; font-size: 0.85rem; color: #ccc; margin-bottom: 0.5rem; font-family: var(--font-tech); }
        input[type="text"], input[type="date"], input[type="password"], input[type="email"], select, textarea {
            width: 100%; box-sizing: border-box; background: rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(255, 255, 255, 0.2); color: #fff; padding: 0.8rem; border-radius: 6px;
        }
        #upload-box { border: 1px dashed rgba(255, 255, 255, 0.3); border-radius: 6px; padding: 2rem; text-align: center; background: rgba(255, 255, 255, 0.03); cursor: pointer; }
        .btn-modal-action {
            width: 100%; padding: 12px; border-radius: 30px; border: none;
            background: linear-gradient(135deg, var(--accent-gold), #b8860b);
            color: #000; font-weight: bold; font-size: 1rem; cursor: pointer; box-shadow: 0 4px 15px rgba(212, 175, 55, 0.3);
        }
        .btn-modal-action.plan-mode { background: linear-gradient(135deg, #00d2ff, #0077ff); box-shadow: 0 4px 15px rgba(0, 210, 255, 0.3); color: #fff; }
        
        .checkbox-wrapper { display: flex; align-items: center; gap: 10px; margin-top: 10px; cursor: pointer; }
        .checkbox-wrapper input { width: auto; margin: 0; }
        
        .user-list-item { display: flex; align-items: center; gap: 10px; padding: 10px; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .user-list-icon { width: 32px; height: 32px; border-radius: 50%; object-fit: cover; border: 1px solid #555; }

        .loading { text-align: center; padding: 3rem; opacity: 0.6; font-family: var(--font-tech); }
        @keyframes slideIn { to { opacity: 1; transform: translateY(0); } }

        /* â–¼â–¼â–¼ è¿½åŠ ãƒ»ä¿®æ­£: ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã®ãƒ‡ã‚¶ã‚¤ãƒ³å¼·åŒ–ï¼ˆ1ã¤ã®æ ã«3ã¤çµ±åˆï¼‰ â–¼â–¼â–¼ */
        .auth-container {
            background: rgba(15, 20, 30, 0.9);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 1.5rem;
            box-shadow: inset 0 0 30px rgba(0,0,0,0.5);
        }
        
        /* 1ã¤ã®æ ã«ã¾ã¨ã‚ã‚‹ã‚¹ã‚¿ã‚¤ãƒ« */
        .auth-features-unified {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(212, 175, 55, 0.3); /* ã‚´ãƒ¼ãƒ«ãƒ‰ã®æ  */
            border-radius: 8px;
            padding: 1.2rem;
            margin-bottom: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .feat-row {
            display: flex;
            align-items: center;
            gap: 12px;
            color: #ddd;
            font-size: 0.9rem;
        }
        
        .feat-icon-small {
            color: var(--accent-gold);
            font-size: 1.1rem;
            width: 24px; 
            text-align: center;
        }

        .auth-desc {
            font-size: 0.85rem; color: #aaa; line-height: 1.4; margin-bottom: 1rem; text-align: center;
            font-family: 'Shippori Mincho', serif;
        }

        .input-group { position: relative; margin-bottom: 1rem; }
        .input-group input {
            padding-left: 2.5rem;
            background: rgba(0, 0, 0, 0.5);
            border-color: rgba(255, 255, 255, 0.15);
            transition: 0.3s;
            padding-top: 0.7rem; padding-bottom: 0.7rem; 
        }
        .input-group input:focus {
            background: rgba(0, 0, 0, 0.8);
            border-color: var(--accent-gold);
            box-shadow: 0 0 10px rgba(212, 175, 55, 0.2);
        }
        .input-icon {
            position: absolute; left: 12px; top: 50%; transform: translateY(-50%);
            color: rgba(255, 255, 255, 0.4); font-size: 1rem; pointer-events: none;
        }

        /* ãƒ­ã‚°ã‚¤ãƒ³ãƒœãƒƒã‚¯ã‚¹è‡ªä½“ã®è£…é£¾å¼·åŒ– */
        .login-box-deco {
            border: 1px solid rgba(212, 175, 55, 0.5) !important;
            box-shadow: 0 0 60px rgba(0,0,0,0.9), 0 0 20px rgba(212, 175, 55, 0.15) !important;
            background: linear-gradient(160deg, rgba(20, 25, 35, 0.98), rgba(10, 15, 25, 0.95)) !important;
        }

        .error-msg {
            color: #ff6b6b; font-size: 0.8rem; min-height: 1.2em; 
            margin-bottom: 0.8rem; text-align: center; 
            background: rgba(255, 80, 80, 0.1);
            padding: 6px; border-radius: 4px; border: 1px solid rgba(255, 80, 80, 0.2);
            display: none; /* ã‚¨ãƒ©ãƒ¼ãŒãªã„ã¨ãã¯éè¡¨ç¤º */
        }
        .error-msg.show { display: block; animation: fadeIn 0.3s; }

        .auth-links {
            margin-top: 1.2rem; font-size: 0.8rem; text-align: center; color: #aaa;
        }
        .auth-links span {
            cursor: pointer; text-decoration: underline; transition: color 0.3s;
        }
        .auth-links span:hover { color: #fff; text-shadow: 0 0 5px #fff; }
    </style>
</head>
<body>

    <div class="menu-container">
        <button id="menu-toggle" class="menu-toggle" aria-label="ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é–‹ã">
            <span class="line"></span><span class="line"></span><span class="line"></span>
        </button>
        <nav id="nav-overlay" class="nav-overlay">
            <ul class="nav-list">
                <li><a href="index.html" class="nav-link">ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸<span>Home</span></a></li>
                <li><a href="stars.html" class="nav-link">æ˜Ÿã‚’æ¢ã™<span>Star Chart</span></a></li>
                <li><a href="events.html" class="nav-link">æ˜Ÿç©ºæƒ…å ±å±€<span>Sky Events</span></a></li>
                <li><a href="theater.html" class="nav-link">å®‡å®™ã‚·ã‚¢ã‚¿ãƒ¼<span>Space Theater</span></a></li>
                <li><a href="lifelog.html" class="nav-link">æ˜Ÿç©ºãƒ©ã‚¤ãƒ•ãƒ­ã‚°<span>My Starry Sky Log</span></a></li>
            </ul>
        </nav>
    </div>

    <header class="common-header">
        <a href="index.html" class="header-back-btn">ãƒˆãƒƒãƒ—ã¸æˆ»ã‚‹</a>
        <h1 class="page-title">æ˜Ÿç©ºãƒ©ã‚¤ãƒ•ãƒ­ã‚°<span>My Starry Sky Log</span></h1>
    </header>

    <div class="dashboard-container" id="app-container" style="display:none;">
        
        <aside class="left-column">
            <div class="smart-card profile-panel">
                <button class="btn-logout" onclick="signOut()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
                <button class="btn-edit-profile" onclick="openProfileModal()">âš™ï¸</button>
                <div class="avatar-circle">
                    <img id="avatar-img" src="" style="display:none;">
                    <span id="avatar-default" class="avatar-default">ğŸ”­</span>
                </div>
                <h2 id="display-name" class="user-name">Guest User</h2>
                <div id="display-email-sub" class="user-email">guest@example.com</div>
                <div class="stats-row">
                    <div class="stat-item log-theme">
                        <div class="stat-val" id="stat-total">0</div>
                        <div class="stat-label">LOGS</div>
                    </div>
                    <div class="stat-item plan-theme">
                        <div class="stat-val" id="stat-plans">0</div>
                        <div class="stat-label">PLANS</div>
                    </div>
                </div>
            </div>

            <div class="action-panel">
                <button class="btn-plan" onclick="openModal('plan')">ğŸ“… è¦³æ¸¬è¨ˆç”»ã‚’ç«‹ã¦ã‚‹</button>
            </div>

            <div class="smart-card" id="plans-card">
                <div class="panel-header"><div class="panel-title" id="plans-header">è¦³æ¸¬äºˆå®š -PLANS-</div></div>
                <div id="plans-list" class="wishlist-container">
                    <p style="opacity:0.4; font-size:0.8rem; text-align:center; padding:1rem;">äºˆå®šã¯ã‚ã‚Šã¾ã›ã‚“</p>
                </div>
            </div>
        </aside>

        <main class="right-column">
            <div class="page-heading">
                <div class="tab-group">
                    <button class="tab-btn active" id="tab-my" onclick="switchMode('my')">ğŸ“– è‡ªåˆ†ã®æ—¥èªŒ</button>
                    <button class="tab-btn" id="tab-global" onclick="switchMode('global')">ğŸŒ ã¿ã‚“ãªã®æ—¥èªŒ</button>
                    <button class="tab-btn tab-blue" id="tab-plans" onclick="switchMode('plans')">ğŸ”­ ã¿ã‚“ãªã®è¦³æ¸¬äºˆå®š</button>
                </div>
                <button class="btn-add-log" onclick="openModal('log')">ï¼‹ æ˜Ÿç©ºæ—¥èªŒã‚’æ›¸ã</button>
            </div>
            <div id="logs-list">
                <div class="loading">Loading...</div>
            </div>
        </main>
    </div>

    <div id="auth-overlay" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(2,5,10,0.95); z-index:2000; display:flex; align-items:center; justify-content:center; backdrop-filter:blur(8px); overflow-y:auto;">
        
        <div id="view-login" class="modal-box login-box-deco">
            <div style="text-align:center; margin-bottom:1.5rem;">
                <div style="font-size:3rem; margin-bottom:0.5rem;">ğŸ”­</div>
                <h2 class="modal-h" style="border:none; padding:0; margin:0; text-shadow:0 0 10px rgba(212,175,55,0.5);">ãƒ­ã‚°ã‚¤ãƒ³</h2>
                <p style="font-size:0.8rem; color:#888; letter-spacing:0.1em;">Starry Sky Log</p>
            </div>
            
            <p class="auth-desc">ãƒ­ã‚°ã‚¤ãƒ³ã™ã‚‹ã¨ä»¥ä¸‹ã®æ©Ÿèƒ½ãŒä½¿ãˆã¾ã™</p>

            <div class="auth-features-unified">
                <div class="feat-row">
                    <span class="feat-icon-small">ğŸ“–</span>
                    <span>æ˜Ÿã‚’è¦‹ãŸè¨˜éŒ²ã‚’ä»˜ã‘ã‚‹</span>
                </div>
                <div class="feat-row">
                    <span class="feat-icon-small">ğŸŒ</span>
                    <span>èª°ã‹ã®è¨˜éŒ²ã‚’è¦‹ã‚‹</span>
                </div>
                <div class="feat-row">
                    <span class="feat-icon-small">ğŸ“…</span>
                    <span>è¦³æ¸¬äºˆå®šã‚’ç«‹ã¦ã‚‹</span>
                </div>
            </div>

            <p id="login-error" class="error-msg"></p>
            
            <div class="input-group">
                <span class="input-icon">âœ‰ï¸</span>
                <input type="email" id="login-email" placeholder="ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹">
            </div>
            <div class="input-group">
                <span class="input-icon">ğŸ”‘</span>
                <input type="password" id="login-pass" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰">
            </div>
            
            <button onclick="signIn()" class="btn-modal-action">ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦å§‹ã‚ã‚‹</button>
            
            <div class="auth-links">
                <span onclick="switchView('forgot')">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å¿˜ã‚ŒãŸå ´åˆ</span>
                <span style="border-left:1px solid #555; margin:0 15px; height:12px; display:inline-block;"></span>
                <span onclick="switchView('signup')" style="color:#d4af37;">æ–°è¦ç™»éŒ²ã¯ã“ã¡ã‚‰</span>
            </div>
        </div>

        <div id="view-signup" style="display:none;" class="modal-box login-box-deco">
            <h2 class="modal-h" style="margin-bottom:1.5rem;">SIGN UP</h2>
            <p class="auth-desc">ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ä½œæˆã—ã¦<br>ã‚ãªãŸã ã‘ã®æ˜Ÿç©ºè¨˜éŒ²ã‚’å§‹ã‚ã¾ã—ã‚‡ã†ã€‚</p>
            
            <p id="signup-error" class="error-msg"></p>
            
            <div class="input-group">
                <span class="input-icon">âœ‰ï¸</span>
                <input type="email" id="signup-email" placeholder="ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹">
            </div>
            <div class="input-group">
                <span class="input-icon">ğŸ”‘</span>
                <input type="password" id="signup-pass" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ (8æ–‡å­—ä»¥ä¸Š)">
            </div>
            
            <button onclick="signUp()" class="btn-modal-action">èªè¨¼ã‚³ãƒ¼ãƒ‰ã‚’é€ä¿¡</button>
            <div class="auth-links">
                <span onclick="switchView('login')">ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã¸æˆ»ã‚‹</span>
            </div>
        </div>

        <div id="view-verify" style="display:none;" class="modal-box login-box-deco">
            <h2 class="modal-h" style="margin-bottom:1.5rem;">VERIFY</h2>
            <p class="auth-desc">ãƒ¡ãƒ¼ãƒ«ã«å±Šã„ãŸèªè¨¼ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</p>
            <p id="verify-error" class="error-msg"></p>
            
            <div class="input-group">
                <span class="input-icon">ğŸ”¢</span>
                <input type="text" id="verify-code" placeholder="èªè¨¼ã‚³ãƒ¼ãƒ‰ (ä¾‹: 123456)">
            </div>
            
            <button onclick="verifyCode()" class="btn-modal-action">èªè¨¼ã—ã¦å®Œäº†</button>
            <div class="auth-links">
                <span onclick="switchView('signup')">æˆ»ã‚‹</span>
            </div>
        </div>

        <div id="view-forgot" style="display:none;" class="modal-box login-box-deco">
            <h2 class="modal-h" style="margin-bottom:1.5rem;">RESET PASSWORD</h2>
            <p class="auth-desc">ç™»éŒ²ã—ãŸãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚<br>ãƒªã‚»ãƒƒãƒˆç”¨ã®ã‚³ãƒ¼ãƒ‰ã‚’é€ä¿¡ã—ã¾ã™ã€‚</p>
            <p id="forgot-error" class="error-msg"></p>
            
            <div class="input-group">
                <span class="input-icon">âœ‰ï¸</span>
                <input type="email" id="forgot-email" placeholder="ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹">
            </div>
            
            <button onclick="sendResetCode()" class="btn-modal-action">ã‚³ãƒ¼ãƒ‰ã‚’é€ä¿¡</button>
            <div class="auth-links">
                <span onclick="switchView('login')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</span>
            </div>
        </div>

        <div id="view-reset-submit" style="display:none;" class="modal-box login-box-deco">
            <h2 class="modal-h" style="margin-bottom:1.5rem;">NEW PASSWORD</h2>
            <p class="auth-desc">ãƒ¡ãƒ¼ãƒ«ã«å±Šã„ãŸã‚³ãƒ¼ãƒ‰ã¨ã€<br>æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</p>
            <p id="reset-error" class="error-msg"></p>
            
            <div class="input-group">
                <span class="input-icon">ğŸ”¢</span>
                <input type="text" id="reset-code" placeholder="èªè¨¼ã‚³ãƒ¼ãƒ‰">
            </div>
            <div class="input-group">
                <span class="input-icon">ğŸ”‘</span>
                <input type="password" id="reset-new-pass" placeholder="æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰">
            </div>
            
            <button onclick="submitResetPassword()" class="btn-modal-action">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´</button>
        </div>
    </div>

    <div id="modal-overlay" class="modal-overlay">
        <div class="modal-box">
            <button class="modal-close" onclick="closeModal()">Ã—</button>
            <h3 class="modal-h" id="modal-heading">è¨˜éŒ²ã‚’ä½œæˆ</h3>
            <form id="unified-form">
                <input type="hidden" id="input-type" value="log">
                <div class="form-row form-grp">
                    <div><label>æ—¥ä»˜</label><input type="date" id="input-date" required></div>
                    <div><label>å¯¾è±¡ / ã‚¿ã‚¤ãƒˆãƒ«</label><input type="text" id="input-target" placeholder="ä¾‹: ã‚ªãƒªã‚ªãƒ³åº§" required></div>
                </div>
                <div id="log-fields">
                    <div class="form-row form-grp">
                        <div><label>æ©Ÿæ</label><select id="input-tool"><option>è‚‰çœ¼</option><option>åŒçœ¼é¡</option><option>å¤©ä½“æœ›é é¡</option><option>ã‚«ãƒ¡ãƒ©</option></select></div>
                        <div><label>è©•ä¾¡</label><select id="input-rating"><option value="5">â˜…â˜…â˜…â˜…â˜…</option><option value="4">â˜…â˜…â˜…â˜…â˜†</option><option value="3">â˜…â˜…â˜…â˜†â˜†</option><option value="2">â˜…â˜…â˜†â˜†â˜†</option><option value="1">â˜…â˜†â˜†â˜†â˜†</option></select></div>
                    </div>
                    <div class="form-grp">
                        <label>å†™çœŸ (1æšã®ã¿)</label>
                        <div id="upload-box" onclick="document.getElementById('input-file').click()">
                            <span style="font-size:0.9rem; opacity:0.8;">ğŸ“· ã‚¯ãƒªãƒƒã‚¯ã—ã¦å†™çœŸã‚’é¸æŠ</span>
                            <input type="file" id="input-file" accept="image/*" style="display:none" onchange="previewImage(this)">
                        </div>
                        <div id="preview-area" style="display:none; position:relative; text-align:center;">
                            <img id="preview-img-tag" style="max-width:100%; max-height:200px; border:1px solid rgba(255,255,255,0.3); border-radius:4px;">
                            <button type="button" onclick="clearImage()" style="position:absolute; top:-10px; right:-10px; background:#cc4444; color:#fff; border:none; width:24px; height:24px; border-radius:50%; cursor:pointer;">Ã—</button>
                        </div>
                    </div>
                </div>
                <div class="form-grp">
                    <label id="label-comment">ãƒ¡ãƒ¢ãƒ»æ„Ÿæƒ³</label>
                    <textarea id="input-comment" rows="4"></textarea>
                </div>
                <div class="form-grp">
                    <label class="checkbox-wrapper">
                        <input type="checkbox" id="input-public" checked>
                        <span>ã¿ã‚“ãªã«å…¬é–‹ã™ã‚‹</span>
                    </label>
                </div>
                <button type="submit" class="btn-modal-action" id="btn-save">ä¿å­˜ã™ã‚‹</button>
            </form>
        </div>
    </div>

    <div id="user-list-modal" class="modal-overlay">
        <div class="modal-box">
            <button class="modal-close" onclick="document.getElementById('user-list-modal').style.display='none'">Ã—</button>
            <h3 class="modal-h" id="user-list-title">å‚è€ƒã«ã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼</h3>
            <div id="user-list-container" style="max-height:300px; overflow-y:auto;"></div>
        </div>
    </div>

    <div id="profile-modal" class="modal-overlay">
        <div class="modal-box">
            <button class="modal-close" onclick="closeProfileModal()">Ã—</button>
            <h3 class="modal-h">ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç·¨é›†</h3>
            <form id="profile-form">
                <div style="text-align:center; margin-bottom:2rem;">
                    <div style="width:100px; height:100px; border-radius:50%; border:2px solid var(--accent-gold); margin:0 auto; overflow:hidden; position:relative; cursor:pointer; background:#000;" onclick="document.getElementById('input-avatar-file').click()">
                        <img id="profile-preview" src="" style="width:100%; height:100%; object-fit:cover; display:none;">
                        <span id="profile-preview-default" style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); font-size:2rem; opacity:0.5;">ğŸ“·</span>
                    </div>
                    <p style="font-size:0.7rem; margin-top:0.5rem; opacity:0.6;">ã‚¿ãƒƒãƒ—ã—ã¦ç”»åƒã‚’å¤‰æ›´</p>
                    <input type="file" id="input-avatar-file" accept="image/*" style="display:none" onchange="previewProfileImage(this)">
                </div>
                <div class="form-grp">
                    <label>è¡¨ç¤ºå</label>
                    <input type="text" id="input-display-name" required>
                </div>
                <button type="submit" class="btn-modal-action">å¤‰æ›´ã‚’ä¿å­˜</button>
            </form>
        </div>
    </div>

    <script src="assets/js/script.js"></script>
    <script>
        // â–¼â–¼â–¼ è¨­å®šã‚¨ãƒªã‚¢ (å…ƒã®å€¤ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„) â–¼â–¼â–¼
        const API_URL = "https://ef7yxsmrds7qxjopbqyg5x6omm0uaomt.lambda-url.ap-northeast-1.on.aws/";
        const COGNITO_REGION = 'ap-northeast-1';
        const USER_POOL_ID = 'ap-northeast-1_kXEnG6ST0'; 
        const CLIENT_ID = '1fsbv088bo29u6ob8gaavn4jll'; 
        // â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²

        const { Auth } = aws_amplify;
        aws_amplify.Amplify.configure({
            Auth: { region: COGNITO_REGION, userPoolId: USER_POOL_ID, userPoolWebClientId: CLIENT_ID }
        });

        // å…±é€šå¤‰æ•°
        let currentSession = null;
        let selectedImageBase64 = null; 
        let profileImageBase64 = null;  
        let myProfile = { name: 'Guest', icon: '' }; 
        let currentMode = 'my'; 
        let convertingPlanId = null;
        let myDataCache = []; 
        let editingLog = null; 
        let myUserId = null; 

        document.querySelector('.dashboard-container').addEventListener('mousemove', (e) => {
            const cards = document.querySelectorAll('.smart-card, .feed-card');
            cards.forEach(card => {
                const rect = card.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                card.style.setProperty('--mouse-x', `${x}px`);
                card.style.setProperty('--mouse-y', `${y}px`);
            });
        });

        // --- ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•° ---
        function escapeHtml(s) { 
            return s ? s.replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','':'&quot;','\'':'&#039;'}[m])) : ""; 
        }

        function makeCommentHtml(comment) {
            const MAX_LEN = 80;
            if (comment && comment.length > MAX_LEN) {
                const shortText = escapeHtml(comment.substr(0, MAX_LEN)) + '...';
                const fullText = escapeHtml(comment).replace(/\n/g, '<br>');
                return `<span class="text-short">${shortText}</span><span class="text-full" style="display:none;">${fullText}</span><span class="read-more-btn" onclick="event.stopPropagation(); toggleComment(this)" style="color:var(--accent-gold); cursor:pointer; font-size:0.8rem; margin-left:5px;">ã•ã‚‰ã«è¡¨ç¤º â‰«</span>`;
            } else {
                return escapeHtml(comment || '').replace(/\n/g, '<br>');
            }
        }

        function toggleComment(btn) {
            const parent = btn.parentElement;
            const short = parent.querySelector('.text-short');
            const full = parent.querySelector('.text-full');
            if (short.style.display !== 'none') {
                short.style.display = 'none'; full.style.display = 'block'; btn.textContent = 'â‰ª é–‰ã˜ã‚‹';
            } else {
                short.style.display = 'inline'; full.style.display = 'none'; btn.textContent = 'ã•ã‚‰ã«è¡¨ç¤º â‰«';
            }
        }

        function togglePlan(el) { el.classList.toggle('active'); }

        // --- èªè¨¼ãƒ»åˆæœŸåŒ–ãƒ­ã‚¸ãƒƒã‚¯ ---
        checkUser();

        async function checkUser() {
            try {
                const user = await Auth.currentAuthenticatedUser();
                currentSession = await Auth.currentSession();
                myUserId = user.attributes.sub;
                showDashboard(user);
            } catch (err) {
                document.getElementById('auth-overlay').style.display = 'flex';
            }
        }

        function showDashboard(user) {
            document.getElementById('auth-overlay').style.display = 'none';
            document.getElementById('app-container').style.display = 'grid';
            const email = user.attributes.email;
            document.getElementById('display-email-sub').textContent = email;
            document.getElementById('display-name').textContent = email.split('@')[0];
            fetchMyDataAndInit();
        }

        function switchMode(mode) {
            currentMode = mode;
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`tab-${mode}`).classList.add('active');
            updateMainContent(mode);
        }

        // --- ãƒ‡ãƒ¼ã‚¿å–å¾—ãƒ»æç”»ãƒ­ã‚¸ãƒƒã‚¯ ---
        async function fetchMyDataAndInit() {
            try {
                const token = currentSession.getAccessToken().getJwtToken();
                const res = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'load', token: token })
                });
                const data = await res.json();
                myDataCache = data.logs || [];
                
                extractProfileFromLogs(myDataCache);
                
                // çµ±è¨ˆæƒ…å ±ã®æ›´æ–°
                const logsCount = myDataCache.filter(d => d.type === 'log').length;
                const plansCount = myDataCache.filter(d => d.type === 'plan').length;
                document.getElementById('stat-total').textContent = logsCount;
                document.getElementById('stat-plans').textContent = plansCount;

                renderMyPlans(myDataCache); 
                updateMainContent(currentMode);
            } catch(e) { console.error(e); }
        }

        function renderMyPlans(data) {
            const plans = data.filter(d => d.type === 'plan');
            const container = document.getElementById('plans-list');
            container.innerHTML = '';

            if(plans.length === 0) {
                container.innerHTML = '<p style="opacity:0.4; font-size:0.8rem; text-align:center; padding:1rem;">äºˆå®šã¯ã‚ã‚Šã¾ã›ã‚“</p>';
                return;
            }
            plans.sort((a,b) => new Date(a.date) - new Date(b.date));

            plans.forEach(plan => {
                const d = new Date(plan.date);
                const dateStr = `${d.getMonth()+1}/${d.getDate()}`;
                const lockIcon = (plan.isPublic === false) ? '<span class="plan-lock">ğŸ”’</span>' : '';
                
                const html = `
                    <div class="plan-item" onclick="togglePlan(this)">
                        ${lockIcon}
                        <div class="plan-head">
                            <div><span class="plan-date">${dateStr}</span> <span style="margin:0 8px; opacity:0.3;">|</span> <span class="plan-title">${escapeHtml(plan.target)}</span></div>
                            <div class="plan-arrow">â–¼</div>
                        </div>
                        <div class="plan-body" onclick="event.stopPropagation()">
                            <div style="font-size:0.85rem; color:#d0d0d0; margin-bottom:0.8rem;">${escapeHtml(plan.comment || 'ãƒ¡ãƒ¢ãªã—')}</div>
                            <div class="plan-btns">
                                <button class="p-btn p-btn-edit" onclick="editLog('${plan.logId}')">ç·¨é›†</button>
                                <button class="p-btn p-btn-rec" onclick="initiateConvert('${plan.logId}')">ãƒ­ã‚°ã«è¨˜éŒ²</button>
                                <button class="p-btn p-btn-del" onclick="deleteItem('${plan.logId}', null)">å‰Šé™¤</button>
                            </div>
                        </div>
                    </div>
                `;
                container.insertAdjacentHTML('beforeend', html);
            });
        }

        async function updateMainContent(mode) {
            const listEl = document.getElementById('logs-list');
            listEl.innerHTML = '<div class="loading">Loading...</div>';

            let itemsToShow = [];

            if (mode === 'my') {
                itemsToShow = myDataCache.filter(d => d.type === 'log');
                renderMainList(itemsToShow, 'log');
            } else {
                try {
                    const token = currentSession.getAccessToken().getJwtToken();
                    const res = await fetch(API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ action: 'load_public', token: token })
                    });
                    const data = await res.json();
                    const publicData = data.logs || [];

                    if (mode === 'global') {
                        itemsToShow = publicData.filter(d => d.type === 'log');
                        renderMainList(itemsToShow, 'log');
                    } else if (mode === 'plans') {
                        itemsToShow = publicData.filter(d => d.type === 'plan');
                        renderMainList(itemsToShow, 'plan'); 
                    }
                } catch(e) {
                    listEl.innerHTML = '<div style="padding:2rem; text-align:center;">èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼</div>';
                }
            }
        }

        function renderMainList(items, type) {
            const container = document.getElementById('logs-list');
            container.innerHTML = '';
            
            if(items.length === 0) {
                container.innerHTML = '<div style="text-align:center; opacity:0.3; padding:3rem;">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>';
                return;
            }

            items.sort((a,b) => new Date(b.date) - new Date(a.date));

            items.forEach((item, i) => {
                const d = new Date(item.date);
                const dateStr = `${d.getFullYear()}.${(d.getMonth()+1).toString().padStart(2,'0')}.${d.getDate().toString().padStart(2,'0')}`;
                
                let userInfoHtml = '';
                if (item.authorName) {
                    const iconSrc = item.authorIcon || ''; 
                    const iconImg = iconSrc ? `<img src="${iconSrc}" class="feed-user-icon">` : `<span class="feed-user-icon" style="background:#333; display:inline-block;"></span>`;
                    userInfoHtml = `<div class="feed-user-info">${iconImg} <span>${escapeHtml(item.authorName)}</span></div>`;
                } else {
                    userInfoHtml = `<div class="feed-user-info" style="opacity:0.5;"><span>Guest User</span></div>`;
                }
                
                let deleteBtn = '';
                let clickAttr = '';
                let cardClass = 'smart-card feed-card';
                let privateMark = '';

                const likedList = item.likedBy || [];
                const usefulList = item.usefulBy || [];
                const likeCount = likedList.length;
                const usefulCount = usefulList.length;
                const likedJson = encodeURIComponent(JSON.stringify(likedList));
                const usefulJson = encodeURIComponent(JSON.stringify(usefulList));

                let myReactionView = '';
                if (currentMode === 'my') {
                    deleteBtn = `<button class="btn-del-log" onclick="event.stopPropagation(); deleteItem('${item.logId}', '${item.imageUrl||''}')">å‰Šé™¤</button>`;
                    clickAttr = `onclick="editLog('${item.logId}')"`;
                    cardClass += ' clickable';
                    if (item.isPublic === false) privateMark = '<span class="private-mark">ğŸ”’ éå…¬é–‹</span>';
                    
                    myReactionView = `
                        <div class="reaction-group">
                            <button class="btn-reaction ${likeCount>0?'liked':''}" onclick="event.stopPropagation(); showRefUsers('${likedJson}', 'like')">
                                <span>â¤</span> ${likeCount}
                            </button>
                            <button class="btn-reaction ${usefulCount>0?'useful':''}" onclick="event.stopPropagation(); showRefUsers('${usefulJson}', 'useful')">
                                <span>â˜…</span> ${usefulCount}
                            </button>
                        </div>
                    `;
                }

                if (type === 'log') {
                    const stars = "â˜…".repeat(parseInt(item.rating||0));
                    let thumbHtml = `<div class="feed-no-img">ğŸ”­</div>`;
                    if(item.imageUrl) thumbHtml = `<img src="${item.imageUrl}" class="feed-img">`;
                    const commentHtml = makeCommentHtml(item.comment || '');

                    let reactionHtml = '';
                    if (currentMode === 'global') {
                        const liked = likedList.some(u => (typeof u === 'string' ? u : u.userId) === myUserId);
                        const useful = usefulList.some(u => (typeof u === 'string' ? u : u.userId) === myUserId);

                        reactionHtml = `
                            <div class="reaction-group">
                                <button class="btn-reaction ${liked?'liked':''}" onclick="event.stopPropagation(); toggleReaction('${item.userId}', '${item.logId}', 'like', this)">
                                    <span>â¤</span> ${likeCount>0 ? likeCount : 'ã„ã„ã­'}
                                </button>
                                <button class="btn-reaction ${useful?'useful':''}" onclick="event.stopPropagation(); toggleReaction('${item.userId}', '${item.logId}', 'useful', this)">
                                    <span>â˜…</span> ${usefulCount>0 ? usefulCount : 'å‚è€ƒ'}
                                </button>
                            </div>
                        `;
                    }

                    const html = `
                        <div class="${cardClass}" style="animation-delay:${i*0.05}s" ${clickAttr}>
                            <div class="feed-img-col">${thumbHtml}<div class="feed-date-badge">${dateStr}</div></div>
                            <div class="feed-content">
                                ${userInfoHtml}
                                <div class="feed-head"><h3 class="feed-title">${escapeHtml(item.target)}${privateMark}</h3><span class="feed-stars">${stars}</span></div>
                                <div class="feed-meta"><span class="meta-tag">æ©Ÿæ: ${escapeHtml(item.tool)}</span></div>
                                <div class="feed-text">${commentHtml}</div>
                                <div class="feed-foot">
                                    ${reactionHtml}
                                    ${myReactionView}
                                    ${deleteBtn}
                                </div>
                            </div>
                        </div>
                    `;
                    container.insertAdjacentHTML('beforeend', html);

                } else {
                    const commentHtml = makeCommentHtml(item.comment || '');
                    const refList = item.referencedBy || [];
                    const refCount = refList.length;
                    const refListJson = encodeURIComponent(JSON.stringify(refList));
                    
                    const refArea = `
                        <div style="display:flex; justify-content:flex-end; gap:5px; margin-top:10px;">
                            ${refCount > 0 ? `<span class="ref-count" onclick="event.stopPropagation(); showRefUsers('${refListJson}', 'useful')">${refCount}äººãŒå‚è€ƒã«ã—ã¦ã„ã¾ã™</span>` : ''}
                            <button class="btn-ref-plan" onclick="event.stopPropagation(); referencePlan('${item.userId}', '${item.logId}')">ã“ã®äºˆå®šã‚’å‚è€ƒã«ã™ã‚‹</button>
                        </div>
                    `;

                    const html = `
                        <div class="smart-card feed-card plan-type" style="animation-delay:${i*0.05}s">
                            <div class="feed-img-col" style="display:flex; align-items:center; justify-content:center; background:rgba(0,0,0,0.3);">
                                <div style="font-size:3rem; color:#00d2ff;">ğŸ“…</div>
                                <div class="feed-date-badge">${dateStr}</div>
                            </div>
                            <div class="feed-content">
                                ${userInfoHtml}
                                <div class="feed-head"><h3 class="feed-title" style="color:#e0f7ff;">${escapeHtml(item.target)}</h3></div>
                                <div class="feed-meta"><span class="meta-tag" style="border-color:#00d2ff; color:#00d2ff; background:rgba(0,210,255,0.1);">Plan</span></div>
                                <div class="feed-text" style="border-top-color:rgba(0,210,255,0.2);">${commentHtml}</div>
                                ${refArea}
                            </div>
                        </div>
                    `;
                    container.insertAdjacentHTML('beforeend', html);
                }
            });
        }

        async function toggleReaction(targetUserId, targetLogId, type, btnEl) {
            try {
                const isLiked = btnEl.classList.contains('liked') || btnEl.classList.contains('useful');
                if(type==='like') btnEl.classList.toggle('liked');
                if(type==='useful') btnEl.classList.toggle('useful');

                const token = currentSession.getAccessToken().getJwtToken();
                const res = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        action: 'toggle_reaction', 
                        token: token,
                        targetUserId: targetUserId,
                        targetLogId: targetLogId,
                        reactionType: type,
                        myName: myProfile.name,
                        myIcon: myProfile.icon
                    })
                });
                const data = await res.json();
                
                if (data.likedBy || data.usefulBy) {
                    const arr = (type==='like') ? data.likedBy : data.usefulBy;
                    const count = arr.length;
                    const hasMe = arr.some(u => (typeof u === 'string' ? u : u.userId) === myUserId);
                    
                    if(hasMe) btnEl.classList.add(type==='like'?'liked':'useful');
                    else btnEl.classList.remove(type==='like'?'liked':'useful');
                    
                    let icon = (type==='like') ? 'â¤' : 'â˜…';
                    let label = (count > 0) ? count : (type==='like' ? 'ã„ã„ã­' : 'å‚è€ƒ');
                    btnEl.innerHTML = `<span>${icon}</span> ${label}`;
                }
            } catch(e) { console.error(e); }
        }

        function showRefUsers(jsonStr, type) {
            const list = JSON.parse(decodeURIComponent(jsonStr));
            const c = document.getElementById('user-list-container');
            const titleEl = document.getElementById('user-list-title');
            
            if(type === 'like') {
                titleEl.textContent = "ã„ã„ã­ã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼";
            } else {
                titleEl.textContent = "å‚è€ƒã«ã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼";
            }

            c.innerHTML = '';
            if(list.length === 0) {
                c.innerHTML = '<div style="padding:1rem; opacity:0.5; text-align:center;">ã¾ã ã‚ã‚Šã¾ã›ã‚“</div>';
            }
            list.forEach(u => {
                let name = 'Unknown User';
                let iconHtml = `<div class="user-list-icon" style="background:#333;</div>`;
                
                if (typeof u === 'string') {
                    name = 'Guest User';
                } else {
                    name = u.name || 'Guest User';
                    if(u.icon) iconHtml = `<img src="${u.icon}" class="user-list-icon">`;
                }

                const div = document.createElement('div');
                div.className = 'user-list-item';
                div.innerHTML = `${iconHtml}<span>${escapeHtml(name)}</span>`;
                c.appendChild(div);
            });
            document.getElementById('user-list-modal').style.display = 'flex';
        }

        function editLog(logId) {
            const target = myDataCache.find(d => d.logId === logId);
            if (!target) return;
            editingLog = target; 
            
            const type = (target.type === 'plan') ? 'plan' : 'log';
            openModal(type);
            document.getElementById('modal-heading').textContent = (type==='plan')?"ãƒ—ãƒ©ãƒ³ã‚’ç·¨é›†":"è¨˜éŒ²ã‚’ç·¨é›†";
            document.getElementById('btn-save').textContent = "æ›´æ–°";

            document.getElementById('input-date').value = target.date;
            document.getElementById('input-target').value = target.target;
            document.getElementById('input-comment').value = target.comment || '';
            document.getElementById('input-public').checked = (target.isPublic !== false);

            if(type === 'log') {
                document.getElementById('input-tool').value = target.tool || 'è‚‰çœ¼';
                document.getElementById('input-rating').value = target.rating || '5';
                if(target.imageUrl) {
                    document.getElementById('upload-box').style.display='none';
                    document.getElementById('preview-area').style.display='block';
                    document.getElementById('preview-img-tag').src = target.imageUrl;
                    selectedImageBase64 = null; 
                }
            }
        }

        async function referencePlan(targetUserId, targetLogId) {
            if(!confirm("ã“ã®äºˆå®šã‚’å‚è€ƒã«ã€ã‚ãªãŸã®äºˆå®šã‚’ä½œæˆã—ã¾ã™ã‹ï¼Ÿ")) return;
            try {
                const token = currentSession.getAccessToken().getJwtToken();
                const body = {
                    action: 'reference_plan',
                    token: token,
                    targetUserId: targetUserId,
                    targetLogId: targetLogId,
                    myName: myProfile.name,
                    myIcon: myProfile.icon
                };
                const res = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });
                if(!res.ok) throw new Error("Failed");
                alert("è‡ªåˆ†ã®äºˆå®šã«è¿½åŠ ã—ã¾ã—ãŸï¼");
                fetchMyDataAndInit(); 
            } catch(e) { alert("ã‚¨ãƒ©ãƒ¼: " + e.message); }
        }

        function extractProfileFromLogs(data) {
            const profile = data.find(d => d.logId === 'profile' || d.type === 'profile');
            if (profile) {
                if(profile.target) {
                    document.getElementById('display-name').textContent = profile.target;
                    myProfile.name = profile.target;
                }
                if(profile.imageUrl) {
                    document.getElementById('avatar-img').src = profile.imageUrl;
                    document.getElementById('avatar-img').style.display = 'block';
                    document.getElementById('avatar-default').style.display = 'none';
                    myProfile.icon = profile.imageUrl;
                }
            }
        }
        
        async function saveItem(dataObj, customId) {
            const token = currentSession.getAccessToken().getJwtToken();
            const body = { action: 'save', token: token, logData: dataObj };
            if(customId) body.logId = customId;
            const res = await fetch(API_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
            return await res.json();
        }

        async function deleteItem(logId, imageUrl, skip) {
            if(!skip && !confirm("å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
            try {
                const token = currentSession.getAccessToken().getJwtToken();
                await fetch(API_URL, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'delete', token: token, logId: logId, logData: { imageUrl: imageUrl } })
                });
                fetchMyDataAndInit();
            } catch(e) { alert("Error: "+e.message); }
        }

        function initiateConvert(planId) {
            const plan = myDataCache.find(d => d.logId === planId);
            if(!plan) return;
            convertingPlanId = planId; 
            editingLog = null; 
            openModal('log');
            document.getElementById('input-date').value = plan.date;
            document.getElementById('input-target').value = plan.target;
            document.getElementById('modal-heading').textContent = "æ˜Ÿç©ºæ—¥èªŒã‚’æ›¸ã";
        }

        function openProfileModal() {
            document.getElementById('profile-modal').style.display = 'flex';
            document.getElementById('input-display-name').value = document.getElementById('display-name').textContent;
            const currentSrc = document.getElementById('avatar-img').src;
            const preview = document.getElementById('profile-preview');
            if(document.getElementById('avatar-img').style.display !== 'none') {
                preview.src = currentSrc; preview.style.display = 'block';
                document.getElementById('profile-preview-default').style.display = 'none';
            }
        }
        function closeProfileModal() { document.getElementById('profile-modal').style.display = 'none'; profileImageBase64 = null; }
        function previewProfileImage(input) { processImage(input, (b64) => { profileImageBase64 = b64; document.getElementById('profile-preview').src = b64; document.getElementById('profile-preview').style.display = 'block'; document.getElementById('profile-preview-default').style.display = 'none'; }); }

        document.getElementById('profile-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = e.target.querySelector('button'); btn.disabled=true; btn.textContent="ä¿å­˜ä¸­...";
            const name = document.getElementById('input-display-name').value;
            const dataObj = { type: 'profile', target: name, imageBase64: profileImageBase64 };
            const curr = myDataCache.find(d => d.logId === 'profile');
            if(curr && !profileImageBase64) dataObj.imageUrl = curr.imageUrl;

            try {
                await saveItem(dataObj, 'profile');
                location.reload(); 
            } catch(e){ alert(e.message); }
            finally { btn.disabled=false; btn.textContent="å¤‰æ›´ã‚’ä¿å­˜"; }
        });

        function openModal(type) {
            const modalBox = document.querySelector('#modal-overlay .modal-box');
            document.getElementById('modal-overlay').style.display = 'flex';
            document.getElementById('input-date').valueAsDate = new Date();
            document.getElementById('input-type').value = type;
            const lf = document.getElementById('log-fields');
            const btn = document.getElementById('btn-save');
            const lbl = document.getElementById('label-comment');
            const h = document.getElementById('modal-heading');
            
            if(type !== 'log') convertingPlanId = null; 

            if(type === 'plan') {
                modalBox.classList.add('plan-theme');
                h.textContent = "è¦³æ¸¬è¨ˆç”»ã‚’ä½œæˆ"; lf.style.display = 'none'; lbl.textContent = "ãƒ¡ãƒ¢"; btn.textContent = "è¿½åŠ ";
                btn.className = "btn-modal-action plan-mode"; 
                document.getElementById('input-date').required = false; 
            } else {
                modalBox.classList.remove('plan-theme');
                h.textContent = "æ—¥èªŒã‚’æ›¸ã"; lf.style.display = 'block'; lbl.textContent = "æ„Ÿæƒ³"; btn.textContent = "ä¿å­˜";
                btn.className = "btn-modal-action"; 
                document.getElementById('input-date').required = true;
            }
        }
        function closeModal() { 
            document.getElementById('modal-overlay').style.display = 'none'; 
            document.getElementById('unified-form').reset(); 
            convertingPlanId = null; 
            editingLog = null; 
            clearImage(); 
            document.getElementById('input-public').checked = true; 
        }
        function processImage(input, cb) {
            if(!input.files[0]) return;
            const r = new FileReader();
            r.onload = (e) => {
                const i = new Image();
                i.onload = () => {
                    const c = document.createElement('canvas');
                    const x = c.getContext('2d');
                    const M = 800; let w=i.width, h=i.height;
                    if(w>M){ h*=M/w; w=M; } c.width=w; c.height=h; x.drawImage(i,0,0,w,h);
                    cb(c.toDataURL('image/jpeg',0.7));
                };
                i.src = e.target.result;
            };
            r.readAsDataURL(input.files[0]);
        }
        function previewImage(inp) { processImage(inp, (b64) => { selectedImageBase64 = b64; document.getElementById('upload-box').style.display='none'; document.getElementById('preview-area').style.display='block'; document.getElementById('preview-img-tag').src=b64; }); }
        function clearImage() { document.getElementById('input-file').value=""; selectedImageBase64=null; document.getElementById('upload-box').style.display='block'; document.getElementById('preview-area').style.display='none'; }

        document.getElementById('unified-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('btn-save'); btn.disabled=true; btn.textContent="é€ä¿¡ä¸­...";
            const type = document.getElementById('input-type').value;
            const data = { 
                type, 
                date: document.getElementById('input-date').value, 
                target: document.getElementById('input-target').value, 
                comment: document.getElementById('input-comment').value,
                authorName: myProfile.name,
                authorIcon: myProfile.icon,
                isPublic: document.getElementById('input-public').checked
            };
            if(type === 'log') {
                data.tool = document.getElementById('input-tool').value;
                data.rating = document.getElementById('input-rating').value;
                
                if(selectedImageBase64) {
                    data.imageBase64 = selectedImageBase64; 
                } else if(editingLog && editingLog.imageUrl && document.getElementById('preview-area').style.display !== 'none') {
                    data.imageUrl = editingLog.imageUrl;
                }
            }
            
            let targetId = null;
            if (editingLog) {
                targetId = editingLog.logId;
                data.referencedBy = editingLog.referencedBy || [];
                data.likedBy = editingLog.likedBy || [];
                data.usefulBy = editingLog.usefulBy || [];
                data.createdAt = editingLog.createdAt; 
            }

            try {
                await saveItem(data, targetId);
                if(convertingPlanId) await deleteItem(convertingPlanId, null, true);
                closeModal(); 
                fetchMyDataAndInit();
            } catch(e) { alert(e.message); }
            finally { btn.disabled=false; btn.textContent=(type==='plan')?"è¿½åŠ ":"ä¿å­˜"; }
        });

        // ----------------------------------------------------
        // â–¼â–¼â–¼ èªè¨¼ãƒ­ã‚¸ãƒƒã‚¯ & ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ—¥æœ¬èªåŒ– â–¼â–¼â–¼
        // ----------------------------------------------------
        
        // AWSã®ã‚¨ãƒ©ãƒ¼ã‚’æ—¥æœ¬èªã«å¤‰æ›ã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
        function translateError(err) {
            const msg = (typeof err === 'string') ? err : (err.message || '');
            if (msg.includes('Incorrect username or password')) return 'ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¾ãŸã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™ã€‚';
            if (msg.includes('User does not exist')) return 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚';
            if (msg.includes('User is not confirmed')) return 'ç™»éŒ²ãŒå®Œäº†ã—ã¦ã„ã¾ã›ã‚“ã€‚èªè¨¼ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚';
            if (msg.includes('Invalid parameter')) return 'å…¥åŠ›å†…å®¹ã«èª¤ã‚ŠãŒã‚ã‚Šã¾ã™ï¼ˆãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯8æ–‡å­—ä»¥ä¸Šãªã©ï¼‰ã€‚';
            if (msg.includes('CodeMismatchException')) return 'èªè¨¼ã‚³ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™ã€‚';
            if (msg.includes('LimitExceededException')) return 'è©¦è¡Œå›æ•°ãŒä¸Šé™ã‚’è¶…ãˆã¾ã—ãŸã€‚ã—ã°ã‚‰ãå¾…ã£ã¦ã‹ã‚‰å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚';
            if (msg.includes('Username exists')) return 'ã“ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¯æ—¢ã«ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™ã€‚';
            if (msg.includes('empty')) return 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚';
            return 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + msg;
        }

        // å…±é€šã‚¨ãƒ©ãƒ¼è¡¨ç¤ºé–¢æ•°
        function showError(elementId, message) {
            const el = document.getElementById(elementId);
            el.textContent = message;
            el.classList.add('show');
        }

        function switchView(n){
            document.querySelectorAll('#auth-overlay > div').forEach(e=>e.style.display='none');
            document.getElementById(`view-${n}`).style.display='block';
            // ã‚¨ãƒ©ãƒ¼è¡¨ç¤ºã‚’ãƒªã‚»ãƒƒãƒˆ
            document.querySelectorAll('.error-msg').forEach(e => {e.textContent=''; e.classList.remove('show');});
        }

        async function signIn(){
            const email = document.getElementById('login-email').value;
            const pass = document.getElementById('login-pass').value;
            
            if(!pass) { showError('login-error', 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚'); return; }
            
            try{
                await Auth.signIn(email, pass);
                checkUser();
            }catch(e){
                showError('login-error', translateError(e));
            }
        }

        async function signUp(){
            const email = document.getElementById('signup-email').value;
            const pass = document.getElementById('signup-pass').value;

            if(!pass) { showError('signup-error', 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚'); return; }

            try{
                await Auth.signUp({username:email, password:pass, attributes:{email:email}});
                switchView('verify');
            }catch(e){
                showError('signup-error', translateError(e));
            }
        }

        async function verifyCode(){
            const email = document.getElementById('signup-email').value;
            const code = document.getElementById('verify-code').value;
            try{
                await Auth.confirmSignUp(email, code);
                alert("ç™»éŒ²ãŒå®Œäº†ã—ã¾ã—ãŸï¼ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚");
                switchView('login');
            }catch(e){
                showError('verify-error', translateError(e));
            }
        }
        async function signOut(){try{await Auth.signOut(),location.reload()}catch(e){}}

        // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆï¼šã‚³ãƒ¼ãƒ‰é€ä¿¡è¦æ±‚
        async function sendResetCode() {
            const email = document.getElementById('forgot-email').value;
            if (!email) {
                showError('forgot-error', "ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
                return;
            }
            try {
                await Auth.forgotPassword(email);
                switchView('reset-submit');
            } catch (e) {
                showError('forgot-error', translateError(e));
            }
        }

        // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆï¼šæ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰è¨­å®š
        async function submitResetPassword() {
            const email = document.getElementById('forgot-email').value;
            const code = document.getElementById('reset-code').value;
            const newPass = document.getElementById('reset-new-pass').value;

            if (!code || !newPass) {
                showError('reset-error', "ã™ã¹ã¦ã®é …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
                return;
            }

            try {
                await Auth.forgotPasswordSubmit(email, code, newPass);
                alert("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å¤‰æ›´ã—ã¾ã—ãŸã€‚æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚");
                switchView('login');
            } catch (e) {
                showError('reset-error', translateError(e));
            }
        }
    </script>
</body>
</html>