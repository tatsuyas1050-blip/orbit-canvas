<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚¤ãƒ™ãƒ³ãƒˆç®¡ç† - Admin</title>
    <link href="https://fonts.googleapis.com/css2?family=Shippori+Mincho:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="assets/css/base.css">
    <link rel="stylesheet" href="assets/css/pages.css">
    <style>
        /* ç®¡ç†ç”»é¢ç”¨ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆèª¿æ•´ */
        .admin-wrapper {
            display: grid;
            grid-template-columns: 1fr 1fr; /* å·¦å³2ã‚«ãƒ©ãƒ  */
            gap: 2rem;
            align-items: start;
        }

        /* å·¦å´ï¼šã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚¨ãƒªã‚¢ */
        .calendar-section {
            background: rgba(5, 10, 20, 0.6);
            border: 1px solid var(--accent-gold);
            border-radius: 8px;
            padding: 1.5rem;
            backdrop-filter: blur(5px);
        }
        /* ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®æ—¥ä»˜ã‚»ãƒ«ã‚’å°‘ã—å°ã•ã‚ã«èª¿æ•´ */
        .calendar-day { min-height: 60px; font-size: 0.9rem; }
        .calendar-day.selected {
            background: rgba(212, 175, 55, 0.3);
            border: 2px solid var(--accent-gold);
        }

        /* å³å´ï¼šç®¡ç†ãƒ‘ãƒãƒ« */
        .manage-panel {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }
        
        .panel-box {
            background: var(--panel-bg);
            padding: 1.5rem;
            border-radius: 8px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        /* ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒˆé …ç›® */
        .event-item {
            background: rgba(255,255,255,0.05);
            padding: 10px 15px;
            margin-bottom: 8px;
            border-radius: 4px;
            border-left: 3px solid var(--accent-gold);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .event-item:hover { background: rgba(255,255,255,0.1); }
        .event-info { cursor: pointer; flex-grow: 1; }
        .btn-delete { background: #ff4444; color: white; border: none; padding: 4px 10px; border-radius: 4px; cursor: pointer; margin-left: 10px;}

        /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ */
        @media (max-width: 900px) {
            .admin-wrapper { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <header class="common-header">
        <a href="index.html" class="header-back-btn">ãƒˆãƒƒãƒ—ã¸æˆ»ã‚‹</a>
        <h1 class="page-title">ç®¡ç†è€…ã‚³ãƒ³ã‚½ãƒ¼ãƒ«</h1>
    </header>

    <div class="container admin-wrapper">
        
        <div class="calendar-section">
            <div class="section-header" style="display:flex; justify-content:space-between; align-items:center; border:none; margin-bottom:1rem;">
                <button class="btn-submit" id="prev-month" style="width:auto; padding:5px 15px;">&lt;</button>
                <div id="current-month" style="font-size:1.3rem; color:var(--accent-gold);">----å¹´ --æœˆ</div>
                <button class="btn-submit" id="next-month" style="width:auto; padding:5px 15px;">&gt;</button>
            </div>
            <div class="calendar-grid" id="calendar-grid"></div>
            <p style="text-align:center; font-size:0.8rem; opacity:0.6; margin-top:1rem;">æ—¥ä»˜ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ç·¨é›†ãƒ»ç™»éŒ²ã‚’è¡Œã„ã¾ã™</p>
        </div>

        <div class="manage-panel">
            
            <div class="panel-box">
                <h2 class="section-header" id="selected-date-label" style="color:var(--text-white); border-bottom-color:var(--accent-gold);">
                    æ—¥ä»˜ã‚’é¸æŠã—ã¦ãã ã•ã„
                </h2>
                <div id="event-list-display">
                    <p style="opacity:0.5;">ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®æ—¥ä»˜ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ã€<br>ã“ã“ã«ç™»éŒ²æ¸ˆã¿ã‚¤ãƒ™ãƒ³ãƒˆãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</p>
                </div>
            </div>

            <div class="panel-box">
                <h3 class="section-header" style="font-size:1rem;">âœï¸ ç·¨é›† / æ–°è¦ç™»éŒ²</h3>
                <form id="admin-form">
                    <div style="margin-bottom:1rem;">
                        <label>ğŸ”‘ åˆè¨€è‘‰</label>
                        <input type="password" id="input-password" placeholder="åˆè¨€è‘‰" required>
                    </div>
                    
                    <input type="hidden" id="input-id"> <input type="hidden" id="input-date"> <div class="form-row">
                        <div>
                            <label>ã‚¿ã‚¤ãƒˆãƒ«</label>
                            <input type="text" id="input-title" required>
                        </div>
                        <div>
                            <label>ã‚¿ã‚¤ãƒ—</label>
                            <select id="input-type">
                                <option value="meteor">ğŸ’« æµæ˜Ÿç¾¤</option>
                                <option value="eclipse">ğŸŒ‘ æ—¥é£Ÿãƒ»æœˆé£Ÿ</option>
                                <option value="phenomenon">ğŸª å¤©æ–‡ç¾è±¡</option>
                                <option value="rocket">ğŸš€ ãƒ­ã‚±ãƒƒãƒˆæ‰“ä¸Š</option>
                                <option value="other">âœ¨ ãã®ä»–</option>
                            </select>
                        </div>
                    </div>

                    <div>
                        <label>æ™‚é–“</label>
                        <input type="text" id="input-time" placeholder="ä¾‹: 22:00é ƒ">
                    </div>
                    
                    <div>
                        <label>ç”»åƒURL</label>
                        <input type="text" id="input-image" placeholder="https://...">
                    </div>

                    <div>
                        <label>è©³ç´°ãƒ»èª¬æ˜</label>
                        <textarea id="input-desc" rows="3" required></textarea>
                    </div>

                    <div style="display:flex; gap:10px; margin-top:1rem;">
                        <button type="submit" class="btn-submit" id="btn-save">ã“ã®å†…å®¹ã§ä¿å­˜</button>
                        <button type="button" class="btn-submit" id="btn-clear" style="background:#555;">ã‚¯ãƒªã‚¢</button>
                    </div>
                    <p id="msg-status" style="margin-top:10px; font-weight:bold; color:var(--accent-gold);"></p>
                </form>
            </div>
        </div>
    </div>

    <script>
        // â–¼â–¼â–¼ ã‚ãªãŸã®é–¢æ•°URLã‚’ã“ã“ã«è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ â–¼â–¼â–¼
        const GET_URL = "https://jjrfmiwd63rogmf7ockaffndty0ddhly.lambda-url.ap-northeast-1.on.aws/";
        const PUT_URL = "https://3k3w7lgiohcqh4i6m4zac534ju0nlvyx.lambda-url.ap-northeast-1.on.aws/";
        // â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²

        // ãƒ‡ãƒ¼ã‚¿ä¿æŒç”¨
        let eventsData = {};
        
        // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ç”¨å¤‰æ•°
        const today = new Date();
        let currentYear = today.getFullYear();
        let currentMonth = today.getMonth();
        let selectedDateStr = ""; // ç¾åœ¨é¸æŠä¸­ã®æ—¥ä»˜ "YYYY-MM-DD"

        // DOMè¦ç´ 
        const gridEl = document.getElementById('calendar-grid');
        const monthLabelEl = document.getElementById('current-month');
        const selectedDateLabel = document.getElementById('selected-date-label');
        const listDisplay = document.getElementById('event-list-display');
        const form = document.getElementById('admin-form');
        const btnSave = document.getElementById('btn-save');
        const statusMsg = document.getElementById('msg-status');

        // åˆæœŸåŒ–å‡¦ç†
        init();

        async function init() {
            // ä»Šæ—¥ã®æ—¥ä»˜æ–‡å­—åˆ—ã‚’ä½œæˆ
            const y = today.getFullYear();
            const m = String(today.getMonth() + 1).padStart(2, '0');
            const d = String(today.getDate()).padStart(2, '0');
            selectedDateStr = `${y}-${m}-${d}`;
            
            await fetchAllEvents(); // å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
            renderCalendar(currentYear, currentMonth); // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æç”»
            selectDate(selectedDateStr); // ä»Šæ—¥ã®æ—¥ä»˜ã‚’é¸æŠçŠ¶æ…‹ã«ã™ã‚‹
        }

        // 1. å…¨ãƒ‡ãƒ¼ã‚¿å–å¾— (Get Lambda)
        async function fetchAllEvents() {
            try {
                const res = await fetch(GET_URL);
                if(!res.ok) throw new Error("Fetch failed");
                eventsData = await res.json();
                console.log("Loaded:", eventsData);
            } catch (e) {
                console.error(e);
                alert("ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ");
            }
        }

        // 2. ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æç”»
        function renderCalendar(year, month) {
            gridEl.innerHTML = '';
            
            // æ›œæ—¥ãƒ˜ãƒƒãƒ€ãƒ¼
            const days = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];
            days.forEach(d => {
                const div = document.createElement('div');
                div.className = 'day-name';
                div.style.textAlign = 'center'; div.style.fontSize = '0.8rem'; div.style.color='rgba(255,255,255,0.6)';
                div.textContent = d;
                gridEl.appendChild(div);
            });

            monthLabelEl.textContent = `${year}å¹´ ${month + 1}æœˆ`;

            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();

            for (let i = 0; i < firstDay; i++) gridEl.appendChild(document.createElement('div'));

            for (let d = 1; d <= daysInMonth; d++) {
                const cell = document.createElement('div');
                cell.className = 'calendar-day';
                const dateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                
                // é¸æŠçŠ¶æ…‹ã®ã‚¹ã‚¿ã‚¤ãƒ«é©ç”¨
                if (dateStr === selectedDateStr) cell.classList.add('selected');

                const numDiv = document.createElement('div');
                numDiv.textContent = d;
                numDiv.style.fontWeight = 'bold'; numDiv.style.marginBottom='4px';
                cell.appendChild(numDiv);

                // ãƒ‰ãƒƒãƒˆè¡¨ç¤º
                if (eventsData[dateStr]) {
                    eventsData[dateStr].forEach(evt => {
                        const dot = document.createElement('span');
                        dot.className = `event-dot dot-${evt.type || 'other'}`;
                        cell.appendChild(dot);
                    });
                }

                cell.addEventListener('click', () => {
                    // é¸æŠæ—¥ã‚’æ›´æ–°ã—ã¦å†æç”»ï¼ˆé¸æŠã‚¹ã‚¿ã‚¤ãƒ«é©ç”¨ã®ãŸã‚ï¼‰
                    selectDate(dateStr);
                });
                gridEl.appendChild(cell);
            }
        }

        // 3. æ—¥ä»˜é¸æŠæ™‚ã®å‡¦ç†
        function selectDate(dateStr) {
            selectedDateStr = dateStr;
            
            // ãƒ©ãƒ™ãƒ«ã¨éš ã—ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰æ›´æ–°
            selectedDateLabel.textContent = `${dateStr} ã®ã‚¤ãƒ™ãƒ³ãƒˆ`;
            document.getElementById('input-date').value = dateStr;
            
            // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®é¸æŠã‚¹ã‚¿ã‚¤ãƒ«æ›´æ–°
            document.querySelectorAll('.calendar-day').forEach(el => el.classList.remove('selected'));
            // (ç°¡æ˜“çš„ãªå†æç”»ã‚ˆã‚Šã‚‚ã€ã‚¯ãƒ©ã‚¹ä»˜ã‘æ›¿ãˆã®æ–¹ãŒè»½é‡ã ãŒã€ä»Šå›ã¯ã‚·ãƒ³ãƒ—ãƒ«ã«å†æç”»ã™ã‚‹)
            renderCalendar(currentYear, currentMonth); 

            // å³å´ã®ãƒªã‚¹ãƒˆæ›´æ–°
            renderEventList(dateStr);
            
            // ãƒ•ã‚©ãƒ¼ãƒ ã‚¯ãƒªã‚¢
            clearForm();
        }

        // 4. ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒˆæç”»
        function renderEventList(dateStr) {
            listDisplay.innerHTML = '';
            const events = eventsData[dateStr] || [];

            if (events.length === 0) {
                listDisplay.innerHTML = '<p style="opacity:0.6;">ã‚¤ãƒ™ãƒ³ãƒˆã¯ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</p>';
                return;
            }

            events.forEach(evt => {
                const div = document.createElement('div');
                div.className = 'event-item';
                div.innerHTML = `
                    <div class="event-info" onclick='loadToForm(${JSON.stringify(evt)})'>
                        <strong>${evt.title}</strong>
                        <span style="font-size:0.8rem; opacity:0.7; margin-left:8px;">${evt.type}</span>
                    </div>
                    <button class="btn-delete" onclick='deleteEvent("${evt.id}")'>å‰Šé™¤</button>
                `;
                listDisplay.appendChild(div);
            });
        }

        // 5. ãƒ•ã‚©ãƒ¼ãƒ ã¸èª­ã¿è¾¼ã¿ï¼ˆç·¨é›†ãƒ¢ãƒ¼ãƒ‰ï¼‰
        window.loadToForm = (evt) => {
            document.getElementById('input-id').value = evt.id || "";
            document.getElementById('input-title').value = evt.title;
            document.getElementById('input-type').value = evt.type;
            document.getElementById('input-time').value = evt.time;
            document.getElementById('input-image').value = evt.image || "";
            document.getElementById('input-desc').value = evt.desc;
            
            btnSave.textContent = "æ›´æ–°ã™ã‚‹ (ä¸Šæ›¸ã)";
            btnSave.style.background = "#4CAF50"; // ç·‘è‰²ã«å¤‰æ›´
            statusMsg.textContent = "ğŸ“ ç·¨é›†ãƒ¢ãƒ¼ãƒ‰: ä¸‹ã®ãƒœã‚¿ãƒ³ã§ä¿å­˜ã—ã¦ãã ã•ã„";
        };

        function clearForm() {
            document.getElementById('input-id').value = "";
            document.getElementById('input-title').value = "";
            document.getElementById('input-desc').value = "";
            document.getElementById('input-image').value = "";
            document.getElementById('input-time').value = "";
            btnSave.textContent = "ã“ã®å†…å®¹ã§æ–°è¦ç™»éŒ²";
            btnSave.style.background = "var(--accent-gold)";
            statusMsg.textContent = "";
        }
        document.getElementById('btn-clear').addEventListener('click', clearForm);

        // 6. ä¿å­˜å‡¦ç† (æ–°è¦/ç·¨é›†)
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('input-id').value;
            const action = id ? "edit" : "add";

            const eventData = {
                id: id,
                title: document.getElementById('input-title').value,
                type: document.getElementById('input-type').value,
                time: document.getElementById('input-time').value,
                image: document.getElementById('input-image').value,
                desc: document.getElementById('input-desc').value
            };

            await sendData(action, eventData);
        });

        // 7. å‰Šé™¤å‡¦ç†
        window.deleteEvent = async (id) => {
            if(!confirm("æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
            await sendData("delete", { id: id });
        };

        // å…±é€šé€ä¿¡é–¢æ•°
        async function sendData(action, eventData) {
            const password = document.getElementById('input-password').value;
            if(!password) { alert("åˆè¨€è‘‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }

            btnSave.disabled = true;
            statusMsg.textContent = "é€ä¿¡ä¸­...";

            try {
                const res = await fetch(PUT_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        password: password,
                        date: selectedDateStr, // é¸æŠä¸­ã®æ—¥ä»˜ã‚’ä½¿ç”¨
                        action: action,
                        eventData: eventData
                    })
                });
                
                const result = await res.json();
                
                if(res.ok) {
                    statusMsg.textContent = "âœ… å‡¦ç†å®Œäº†ï¼";
                    // ãƒ‡ãƒ¼ã‚¿ã‚’å†å–å¾—ã—ã¦ç”»é¢ã‚’æ›´æ–°
                    await fetchAllEvents();
                    renderCalendar(currentYear, currentMonth);
                    renderEventList(selectedDateStr);
                    
                    if(action !== 'edit') clearForm();
                } else {
                    statusMsg.textContent = "â›” ã‚¨ãƒ©ãƒ¼: " + result.message;
                }
            } catch(e) {
                console.error(e);
                statusMsg.textContent = "é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ";
            } finally {
                btnSave.disabled = false;
            }
        }

        // æœˆåˆ‡ã‚Šæ›¿ãˆ
        document.getElementById('prev-month').addEventListener('click', () => {
            currentMonth--; 
            if(currentMonth < 0){ currentMonth = 11; currentYear--; } 
            renderCalendar(currentYear, currentMonth);
        });
        document.getElementById('next-month').addEventListener('click', () => {
            currentMonth++; 
            if(currentMonth > 11){ currentMonth = 0; currentYear++; } 
            renderCalendar(currentYear, currentMonth);
        });
    </script>
</body>
</html>